<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Luxury System</title>

    <!-- Fonts: Prompt (Luxury Thai/English) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- PapaParse (CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Prompt', 'sans-serif'],
                    },
                    colors: {
                        gold: {
                            400: '#EBC76D',
                            500: '#D4AF37', // Primary Gold
                            600: '#B59428',
                        },
                        lux: {
                            white: '#FFFFFF',
                            gray: '#F8F9FA',
                            text: '#2D3748'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F3F4F6;
        }
        /* Custom Scrollbar - Thinner */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #D4AF37; 
        }
        
        .gold-gradient {
            background: linear-gradient(135deg, #D4AF37 0%, #B59428 100%);
        }
        
        /* Layout Fixes for Single Screen */
        .h-main-content {
            height: calc(100vh - 80px); /* Total height minus Header */
        }
    </style>
</head>
<body id="app" class="text-gray-700 antialiased h-screen overflow-hidden flex">

    <!-- Loading Overlay -->
    <div v-if="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-gold-500 mb-4"></i>
            <p class="text-gold-600 font-medium">Processing...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-40 flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-gold-500">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gold-500 text-white text-2xl font-bold mb-4 shadow-lg">
                    QC
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Quality Control System</h1>
                <p class="text-gray-500 text-sm mt-1">Please sign in to continue</p>
            </div>

            <form @submit.prevent="handleLogin">
                <div class="mb-5">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-3 top-3.5 text-gray-400"></i>
                        <input v-model="loginForm.username" type="text" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gold-400 transition" placeholder="Enter username" required>
                    </div>
                </div>
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3.5 text-gray-400"></i>
                        <input v-model="loginForm.password" type="password" class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gold-400 transition" placeholder="Enter password" required>
                    </div>
                </div>
                <button type="submit" class="w-full py-3 rounded-lg text-white font-semibold shadow-lg transform transition hover:scale-[1.02] gold-gradient">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Main Layout -->
    <template v-else>
        <!-- Sidebar -->
        <aside :class="['bg-white shadow-xl flex flex-col z-30 transition-all duration-300', isSidebarOpen ? 'w-64' : 'w-20 hidden md:flex']">
            <!-- Logo -->
            <div class="h-20 flex items-center justify-center border-b border-gray-100 shrink-0">
                <div v-if="isSidebarOpen" class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gold-500 flex items-center justify-center text-white font-bold text-xs">QC</div>
                    <span class="font-bold text-xl tracking-wide text-gray-800">LUX<span class="text-gold-500">QC</span></span>
                </div>
                <div v-else class="w-10 h-10 rounded-full bg-gold-500 flex items-center justify-center text-white font-bold shadow-md">QC</div>
            </div>

            <!-- Menu -->
            <nav class="flex-1 overflow-y-auto py-4 px-2 space-y-1">
                <button @click="currentView = 'qc'" :class="['w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200', currentView === 'qc' ? 'bg-gold-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-gold-500']">
                    <i class="fas fa-qrcode text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">QC Operation</span>
                </button>
                <button @click="currentView = 'report'" :class="['w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200', currentView === 'report' ? 'bg-gold-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-gold-500']">
                    <i class="fas fa-chart-line text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">Reports & KPI</span>
                </button>
                <button @click="currentView = 'history'" :class="['w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200', currentView === 'history' ? 'bg-gold-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-gold-500']">
                    <i class="fas fa-history text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">History Check</span>
                </button>
                <button v-if="isAdmin" @click="currentView = 'settings'" :class="['w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200', currentView === 'settings' ? 'bg-gold-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-gold-500']">
                    <i class="fas fa-cog text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">Settings</span>
                </button>
            </nav>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-100 shrink-0">
                <button @click="handleLogout" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-red-400 hover:bg-red-50 hover:text-red-500 transition-colors">
                    <i class="fas fa-sign-out-alt text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full bg-[#F8F9FA] relative overflow-hidden">
            <!-- Header -->
            <header class="h-20 bg-white shadow-sm flex items-center justify-between px-6 z-20 shrink-0">
                <div class="flex items-center gap-4">
                    <button @click="isSidebarOpen = !isSidebarOpen" class="text-gray-400 hover:text-gold-500 transition focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800">{{ viewTitle }}</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs text-gray-400">Current User</div>
                        <div class="font-semibold text-gray-700">{{ user?.username }} <span class="text-xs text-gold-500 border border-gold-500 rounded px-1">{{ user?.role }}</span></div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center border-2 border-gold-400 text-gold-500">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </header>

            <!-- Content Body (Scrollable or Fitted) -->
            <div class="flex-1 overflow-hidden p-3 relative h-main-content">
                
                <!-- 1. QC Operation View (Fitted Single Screen) -->
                <div v-if="currentView === 'qc'" class="h-full flex flex-col">
                    
                    <!-- Step 1: Upload -->
                    <div v-if="qcState.step === 'upload'" class="flex-1 flex flex-col items-center justify-center">
                        <div class="text-center w-full max-w-2xl mb-8">
                            <div class="border-2 border-dashed border-gray-300 rounded-3xl p-12 bg-white hover:border-gold-500 hover:bg-yellow-50 transition-all cursor-pointer group" @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
                                <input type="file" ref="fileInput" class="hidden" accept=".csv" @change="handleFileUpload">
                                <div class="w-20 h-20 bg-gold-100 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gold-500"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-700 mb-2">Upload Production File</h3>
                                <p class="text-gray-400 mb-6">Drag & drop your CSV file here or click to browse</p>
                                <button class="px-8 py-2 bg-white border border-gray-200 text-gray-600 rounded-full hover:border-gold-500 hover:text-gold-500 transition">Select File</button>
                            </div>
                        </div>

                         <!-- Restore Session Alert -->
                        <div v-if="hasSavedSession" class="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-center justify-between max-w-xl w-full">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-save text-blue-500 text-xl"></i>
                                <div class="text-sm text-blue-800">Found unsaved session from previous work.</div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="clearSavedSession" class="text-xs text-red-500 hover:underline px-2">Discard</button>
                                <button @click="restoreSession" class="text-xs bg-blue-500 text-white px-3 py-1.5 rounded hover:bg-blue-600">Restore</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Dashboard & Scanning (Working) -->
                    <div v-if="qcState.step === 'working'" class="flex flex-col h-full gap-2">
                        <!-- Top Bar: Dashboard Stats + Scanner -->
                        <div class="bg-white p-2 rounded-xl shadow-sm flex items-center justify-between gap-4 shrink-0 h-16">
                            <!-- Stats -->
                            <div class="flex gap-4 items-center pl-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-500"><i class="fas fa-list"></i></div>
                                    <div><p class="text-[10px] text-gray-400 uppercase">Total</p><p class="text-lg font-bold leading-none">{{ totalItems }}</p></div>
                                </div>
                                <div class="h-8 w-px bg-gray-200"></div>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded bg-green-100 flex items-center justify-center text-green-500"><i class="fas fa-check"></i></div>
                                    <div><p class="text-[10px] text-gray-400 uppercase">Pass</p><p class="text-lg font-bold leading-none text-green-600">{{ passedItems }}</p></div>
                                </div>
                                <div class="h-8 w-px bg-gray-200"></div>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded bg-red-100 flex items-center justify-center text-red-500"><i class="fas fa-times"></i></div>
                                    <div><p class="text-[10px] text-gray-400 uppercase">Fail</p><p class="text-lg font-bold leading-none text-red-600">{{ failedItems }}</p></div>
                                </div>
                                <div class="h-8 w-px bg-gray-200"></div>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded bg-gold-100 flex items-center justify-center text-gold-500"><i class="fas fa-hourglass-half"></i></div>
                                    <div><p class="text-[10px] text-gray-400 uppercase">Left</p><p class="text-lg font-bold leading-none text-gray-800">{{ remainingItems }}</p></div>
                                </div>
                            </div>
                            
                            <!-- Scanner & Controls -->
                            <div class="flex items-center gap-2 flex-1 justify-end">
                                <div class="relative w-full max-w-xs">
                                    <i class="fas fa-barcode absolute left-3 top-2.5 text-gray-400"></i>
                                    <input ref="barcodeInput" v-model="barcodeQuery" @keyup.enter="handleScan" type="text" class="w-full pl-9 pr-4 py-1.5 text-sm border rounded-lg focus:ring-2 focus:ring-gold-500 focus:outline-none bg-gray-50" placeholder="Scan Barcode (UID)" autofocus>
                                </div>
                                <button v-if="remainingItems === 0" @click="finishSession" class="px-4 py-1.5 bg-gold-500 text-white text-sm rounded-lg font-bold shadow hover:bg-gold-600 transition animate-pulse whitespace-nowrap">
                                    FINISH
                                </button>
                                <button @click="clearSavedSession" class="text-gray-400 hover:text-red-500 px-2" title="Reset/Clear Data"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>

                        <!-- Main Work Area (3 Columns Layout) -->
                        <div class="flex-1 flex gap-3 overflow-hidden">
                            <!-- Col 1: Item List (Left) -->
                            <div class="w-[220px] bg-white rounded-xl shadow-sm flex flex-col shrink-0">
                                <div class="p-2 bg-gray-50 border-b text-xs font-semibold text-gray-600 flex justify-between uppercase">
                                    <span>Items</span>
                                    <span class="bg-gray-200 px-1.5 rounded">{{ qcData.items.length }}</span>
                                </div>
                                <div class="flex-1 overflow-y-auto p-1 space-y-1">
                                    <div v-for="(item, idx) in qcData.items" :key="idx" 
                                         @click="selectItem(item)"
                                         :class="['p-2 rounded border cursor-pointer transition flex justify-between items-center text-xs', 
                                            item === currentItem ? 'border-gold-500 bg-yellow-50 ring-1 ring-gold-500' : 'border-gray-100 hover:bg-gray-50',
                                            item.status === 'pass' ? 'bg-green-50' : '',
                                            item.status === 'fail' ? 'bg-red-50' : ''
                                         ]">
                                        <div class="overflow-hidden">
                                            <div class="font-bold text-gray-800 truncate">{{ item.uid }}</div>
                                            <div class="text-gray-500 truncate">{{ item.product_name }}</div>
                                        </div>
                                        <div v-if="item.status === 'pass'" class="text-green-500"><i class="fas fa-check-circle"></i></div>
                                        <div v-else-if="item.status === 'fail'" class="text-red-500"><i class="fas fa-times-circle"></i></div>
                                        <div v-else class="text-gray-300"><i class="far fa-circle"></i></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Col 2: Images (Center) - Stacked - EXPANDED WIDTH -->
                            <div class="w-[500px] shrink-0 flex flex-col gap-2 h-full">
                                <!-- Product Image -->
                                <div class="h-1/2 bg-white rounded-xl shadow-sm overflow-hidden flex items-center justify-center relative group border">
                                    <img v-if="productImageUrl" :src="productImageUrl" @error="handleImageError($event, 'product')" class="object-contain w-full h-full p-2 transition transform group-hover:scale-105 duration-300">
                                    <div v-else class="text-gray-400 flex flex-col items-center">
                                        <i class="fas fa-image text-5xl mb-2"></i>
                                        <span class="text-sm">No Product Img</span>
                                    </div>
                                    <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">Product</div>
                                </div>
                                
                                <!-- Cartoon Image -->
                                <div class="h-1/2 bg-white rounded-xl shadow-sm overflow-hidden flex items-center justify-center relative group border">
                                    <img v-if="cartoonImageUrl" :src="cartoonImageUrl" @error="handleImageError($event, 'cartoon')" class="object-contain w-full h-full p-2 transition transform group-hover:scale-105 duration-300">
                                    <div v-else class="text-gray-400 flex flex-col items-center">
                                        <i class="fas fa-icons text-5xl mb-2"></i>
                                        <span class="text-sm">No Pattern Img</span>
                                    </div>
                                    <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">Pattern: {{ currentItem?.cartoon_name || '-' }}</div>
                                </div>
                            </div>

                            <!-- Col 3: Details (Right) - Expanded -->
                            <div class="flex-1 bg-white rounded-xl shadow-sm p-5 overflow-hidden relative flex flex-col shrink-0">
                                <div v-if="currentItem" class="flex flex-col h-full">
                                    <!-- Header Info -->
                                    <div class="flex justify-between items-start mb-4 border-b pb-3 shrink-0">
                                        <div class="overflow-hidden pr-4">
                                            <h2 class="text-2xl font-bold text-gray-800 leading-tight mb-1">{{ currentItem.product_name }}</h2>
                                            <p class="text-sm text-gray-500">Bill: {{ currentItem.bill_no }}</p>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <div class="text-xs text-gray-400">UID</div>
                                            <div class="font-mono text-3xl font-bold text-gold-600">{{ currentItem.uid }}</div>
                                        </div>
                                    </div>

                                    <!-- Scrollable Details -->
                                    <div class="flex-1 overflow-y-auto pr-2 space-y-4">
                                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide mb-2 font-semibold">Text Details</p>
                                            <div v-if="currentItem.line1" class="font-bold text-2xl border-b border-gray-200 pb-2 text-gray-800">{{ currentItem.line1 }}</div>
                                            <div v-if="currentItem.line2" class="font-bold text-2xl border-b border-gray-200 pb-2 mt-2 text-gray-800">{{ currentItem.line2 }}</div>
                                            <div v-if="currentItem.line3" class="font-bold text-2xl mt-2 text-gray-800">{{ currentItem.line3 }}</div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                <div class="text-xs text-gray-500 mb-1">Ink Color</div>
                                                <div class="font-bold text-lg flex items-center gap-3">
                                                    <span class="w-12 h-12 rounded-full border-2 border-white shadow-md" :style="{ backgroundColor: getInkColor(currentItem.ink_color) }"></span>
                                                    {{ currentItem.ink_color || '-' }}
                                                </div>
                                            </div>
                                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                <div class="text-xs text-gray-500 mb-1">Quantity</div>
                                                <div class="font-bold text-2xl text-gray-800">{{ currentItem.qty || 1 }}</div>
                                            </div>
                                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                <div class="text-xs text-gray-500 mb-1">Floor</div>
                                                <div class="font-bold text-lg text-gray-800">{{ currentItem.floor || '-' }}</div>
                                            </div>
                                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                                <div class="text-xs text-gray-500 mb-1">Font</div>
                                                <div class="font-bold text-lg text-gray-800">{{ currentItem.font || '-' }}</div>
                                            </div>
                                        </div>
                                        
                                        <div v-if="currentItem.remark" class="bg-yellow-50 p-3 rounded-xl border border-yellow-200 text-yellow-900 text-sm shadow-sm">
                                            <i class="fas fa-sticky-note mr-2 text-yellow-600"></i><strong>Note:</strong> {{ currentItem.remark }}
                                        </div>
                                    </div>

                                    <!-- Actions Footer -->
                                    <div class="mt-4 pt-3 border-t flex flex-col gap-3 shrink-0">
                                        <div class="flex gap-3">
                                            <button @click="markStatus('fail')" class="flex-1 py-4 bg-white border-2 border-red-500 text-red-500 font-extrabold text-lg rounded-2xl hover:bg-red-50 shadow-sm transition transform active:scale-95">
                                                FAIL
                                            </button>
                                            <button @click="markStatus('pass')" class="flex-1 py-4 bg-green-500 text-white font-extrabold text-lg rounded-2xl hover:bg-green-600 shadow-md transition transform active:scale-95">
                                                PASS
                                            </button>
                                        </div>
                                        <div class="flex justify-between text-sm text-gray-400 px-2">
                                            <div class="flex items-center gap-1"><span class="border px-1 rounded text-xs">←</span> Prev</div>
                                            <div class="flex items-center gap-1">Next <span class="border px-1 rounded text-xs">→</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="h-full flex flex-col items-center justify-center text-gray-400">
                                    <i class="fas fa-search text-6xl mb-4 text-gray-200"></i>
                                    <p class="text-xl text-center font-medium">Scan or Select<br>to view details</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Reports View (Scrollable) -->
                <div v-else-if="currentView === 'report'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Performance Reports</h3>
                        <div class="flex gap-2">
                             <input type="date" v-model="reportFilter.date" class="border rounded-lg px-3 py-2 text-sm">
                             <button @click="fetchReports" class="bg-gold-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gold-600">Filter</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">User</th>
                                    <th class="px-6 py-3">File Name</th>
                                    <th class="px-6 py-3 text-center">Total</th>
                                    <th class="px-6 py-3 text-center text-green-600">Pass</th>
                                    <th class="px-6 py-3 text-center text-red-600">Fail</th>
                                    <th class="px-6 py-3 text-center">KPI (sec/item)</th>
                                    <th class="px-6 py-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="session in reports" :key="session.id" class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-6 py-4">{{ formatDate(session.created_at) }}</td>
                                    <td class="px-6 py-4 font-medium text-gray-900">{{ session.username }}</td>
                                    <td class="px-6 py-4 truncate max-w-xs">{{ session.filename }}</td>
                                    <td class="px-6 py-4 text-center">{{ session.total_items }}</td>
                                    <td class="px-6 py-4 text-center font-bold text-green-600">{{ session.pass_count }}</td>
                                    <td class="px-6 py-4 text-center font-bold text-red-600">{{ session.fail_count }}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ session.kpi_score ? session.kpi_score.toFixed(2) : '-' }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <button @click="downloadReport(session)" class="text-gold-600 hover:text-gold-800 font-medium">Download</button>
                                    </td>
                                </tr>
                                <tr v-if="reports.length === 0">
                                    <td colspan="8" class="text-center py-8 text-gray-400">No reports found for this filter.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 3. History View (Scrollable) -->
                <div v-else-if="currentView === 'history'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">Item History Check</h3>
                    <div class="max-w-xl mx-auto mb-8">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                            <input v-model="historySearch" @keyup.enter="searchHistory" type="text" class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-200 focus:border-gold-500 focus:ring-1 focus:ring-gold-500 focus:outline-none shadow-sm" placeholder="Scan Barcode or Type UID to search...">
                            <button @click="searchHistory" class="absolute right-2 top-2 bg-gold-500 text-white rounded-full px-6 py-1.5 hover:bg-gold-600 text-sm font-medium">Search</button>
                        </div>
                    </div>

                    <div v-if="historyResults.length > 0" class="space-y-4">
                        <div v-for="rec in historyResults" :key="rec.id" class="border rounded-xl p-4 flex justify-between items-center hover:shadow-md transition">
                            <div class="flex gap-4 items-center">
                                <div :class="['w-12 h-12 rounded-full flex items-center justify-center text-xl text-white', rec.status === 'pass' ? 'bg-green-500' : 'bg-red-500']">
                                    <i :class="rec.status === 'pass' ? 'fas fa-check' : 'fas fa-times'"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ rec.item_uid }}</h4>
                                    <p class="text-sm text-gray-500">Checked by <span class="text-gold-600 font-medium">{{ rec.qc_by }}</span> on {{ formatDate(rec.created_at) }}</p>
                                    <p v-if="rec.status === 'fail'" class="text-sm text-red-500 mt-1">Reason: {{ rec.fail_reason }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600">Session ID: {{ rec.session_id }}</span>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="historySearched" class="text-center py-10 text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p>No history found for this item.</p>
                    </div>
                </div>

                <!-- 4. Settings View (Admin) - Scrollable -->
                <div v-else-if="currentView === 'settings'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-800 mb-6">System Settings</h3>
                    
                    <div class="flex border-b border-gray-200 mb-6">
                        <button v-for="tab in ['users', 'reasons', 'ink', 'upload']" :key="tab" 
                            @click="settingsTab = tab"
                            :class="['px-6 py-3 font-medium text-sm transition-colors border-b-2', settingsTab === tab ? 'border-gold-500 text-gold-600' : 'border-transparent text-gray-500 hover:text-gray-700']">
                            {{ tab.charAt(0).toUpperCase() + tab.slice(1) }}
                        </button>
                    </div>

                    <!-- Users Tab -->
                    <div v-if="settingsTab === 'users'">
                        <div class="mb-4 flex gap-2">
                            <input v-model="newUser.username" placeholder="Username" class="border rounded px-3 py-2 text-sm">
                            <input v-model="newUser.password" placeholder="Password" class="border rounded px-3 py-2 text-sm">
                            <select v-model="newUser.role" class="border rounded px-3 py-2 text-sm">
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button @click="addUser" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">Add User</button>
                        </div>
                        <ul class="divide-y">
                            <li v-for="u in settingsData.users" :key="u.id" class="py-3 flex justify-between items-center">
                                <span>{{ u.username }} <span class="text-xs bg-gray-200 px-1 rounded ml-2">{{ u.role }}</span></span>
                                <button @click="deleteUser(u.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </li>
                        </ul>
                    </div>

                    <!-- Reasons Tab -->
                    <div v-if="settingsTab === 'reasons'">
                         <div class="mb-4 flex gap-2">
                            <input v-model="newReason" placeholder="New Fail Reason" class="border rounded px-3 py-2 text-sm flex-1">
                            <button @click="addReason" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">Add</button>
                        </div>
                        <ul class="divide-y">
                            <li v-for="r in settingsData.reasons" :key="r.id" class="py-3 flex justify-between items-center">
                                <span>{{ r.reason_text }}</span>
                                <button @click="deleteReason(r.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </li>
                            <li v-if="settingsData.reasons.length === 0" class="py-4 text-center text-gray-400">No reasons found. Add one above.</li>
                        </ul>
                    </div>

                     <!-- Ink Tab -->
                     <div v-if="settingsTab === 'ink'">
                        <div class="mb-4 flex gap-2 items-center">
                           <input v-model="newInk.name" placeholder="Ink Name" class="border rounded px-3 py-2 text-sm">
                           <input v-model="newInk.hex" type="color" class="h-9 w-12 cursor-pointer border rounded bg-white p-1">
                           <button @click="addInk" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">Add</button>
                       </div>
                       <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                           <div v-for="ink in settingsData.ink" :key="ink.id" class="p-3 border rounded-lg flex items-center justify-between bg-gray-50">
                               <div class="flex items-center gap-2">
                                   <div class="w-6 h-6 rounded-full shadow-sm border" :style="{backgroundColor: ink.hex_code}"></div>
                                   <span class="text-sm font-medium">{{ ink.ink_name }}</span>
                               </div>
                               <button @click="deleteInk(ink.id)" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                           </div>
                       </div>
                   </div>

                    <!-- Upload Image Tab (Multiple) -->
                    <div v-if="settingsTab === 'upload'">
                        <div class="max-w-lg mx-auto bg-gray-50 p-6 rounded-xl border border-dashed border-gray-300 text-center">
                             <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Target Bucket</label>
                                <select v-model="uploadBucket" class="w-full border rounded px-3 py-2">
                                    <option value="Product_Pic">Product_Pic</option>
                                    <option value="Cartoon_Pic">Cartoon_Pic</option>
                                </select>
                             </div>
                             <!-- Added 'multiple' attribute -->
                             <input type="file" ref="imageUploader" accept="image/*" multiple class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gold-50 file:text-gold-700 hover:file:bg-gold-100 mb-4"/>
                             <button @click="uploadImages" class="bg-gold-500 text-white px-6 py-2 rounded-full font-medium hover:bg-gold-600 shadow-md">Upload to Storage</button>
                        </div>
                        <div class="mt-4 text-center text-xs text-gray-400">
                            * Files will keep original names (Thai/Spaces supported).
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </template>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch, nextTick } = Vue;
        const { createClient } = supabase;

        // Config
        const SUPABASE_URL = 'https://otswcrrcidtkpjijirax.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90c3djcnJjaWR0a3BqaWppcmF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDgxODEsImV4cCI6MjA4MTU4NDE4MX0.PGSeQWK7bH5QEyG5do7gnxYhw560QioL1elsf2T0r84';
        
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                // --- State ---
                const loading = ref(false);
                const user = ref(null);
                const isSidebarOpen = ref(true);
                const currentView = ref('qc'); // qc, report, history, settings
                const barcodeQuery = ref('');
                const barcodeInput = ref(null);
                const hasSavedSession = ref(false);

                // Login Form
                const loginForm = reactive({ username: '', password: '' });

                // QC State
                const qcState = reactive({
                    step: 'upload', // upload, working, finish
                    startTime: null,
                    endTime: null,
                    sessionId: null,
                    filename: ''
                });

                // QC Data
                const qcData = reactive({
                    items: [] 
                });

                const currentItem = ref(null);
                const settingsData = reactive({
                    users: [],
                    reasons: [],
                    ink: []
                });
                const settingsTab = ref('users');

                // Reports & History
                const reports = ref([]);
                const reportFilter = reactive({ date: new Date().toISOString().split('T')[0] });
                const historySearch = ref('');
                const historyResults = ref([]);
                const historySearched = ref(false);
                
                // Admin Settings Inputs
                const newUser = reactive({ username: '', password: '', role: 'user' });
                const newReason = ref('');
                const newInk = reactive({ name: '', hex: '#000000' });
                const uploadBucket = ref('Product_Pic');
                const imageUploader = ref(null);

                // --- Computed ---
                const isLoggedIn = computed(() => !!user.value);
                const isAdmin = computed(() => user.value && user.value.role === 'admin');
                const viewTitle = computed(() => {
                    const map = { qc: 'QC Operation', report: 'Reports & KPI', history: 'Check History', settings: 'Settings' };
                    return map[currentView.value];
                });

                const totalItems = computed(() => qcData.items.reduce((acc, i) => acc + parseInt(i.qty || 1), 0));
                const passedItems = computed(() => qcData.items.filter(i => i.status === 'pass').reduce((acc, i) => acc + parseInt(i.qty || 1), 0));
                const failedItems = computed(() => qcData.items.filter(i => i.status === 'fail').reduce((acc, i) => acc + parseInt(i.qty || 1), 0));
                const remainingItems = computed(() => totalItems.value - passedItems.value - failedItems.value);

                const productImageUrl = computed(() => {
                    if (!currentItem.value || !currentItem.value.product_name) return null;
                    return getPublicUrl('Product_Pic', currentItem.value.product_name);
                });

                const cartoonImageUrl = computed(() => {
                    if (!currentItem.value || !currentItem.value.cartoon_name) return null;
                    return getPublicUrl('Cartoon_Pic', currentItem.value.cartoon_name);
                });

                // --- Lifecycle ---
                onMounted(() => {
                    generateFavicon();

                    // Check Auth
                    const savedUser = localStorage.getItem('qc_user');
                    if (savedUser) {
                        user.value = JSON.parse(savedUser);
                        fetchSettings();
                    }

                    // Check for saved session
                    checkSavedSession();

                    // Keyboard listener for arrows
                    window.addEventListener('keydown', handleKeydown);
                });

                onUnmounted(() => {
                    window.removeEventListener('keydown', handleKeydown);
                });

                // Auto-save session
                watch([() => qcData.items, qcState], () => {
                    if (qcState.step === 'working' && qcData.items.length > 0) {
                        const payload = {
                            state: qcState,
                            items: qcData.items,
                            currentItemIndex: currentItem.value ? qcData.items.indexOf(currentItem.value) : -1,
                            timestamp: new Date().getTime()
                        };
                        localStorage.setItem('qc_backup_session', JSON.stringify(payload));
                    }
                }, { deep: true });

                // Watch for view changes to focus scanner
                watch([currentView, () => qcState.step], ([newView, newStep]) => {
                    if (newView === 'qc' && newStep === 'working') {
                        nextTick(() => barcodeInput.value?.focus());
                    }
                });

                // --- Methods ---

                const handleKeydown = (e) => {
                    // Only active in QC working step
                    if (qcState.step !== 'working') return;
                    // Ignore if typing in an input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                    if (e.key === 'ArrowLeft') {
                        navigateItem(-1);
                    } else if (e.key === 'ArrowRight') {
                        navigateItem(1);
                    }
                };

                // Session Management
                const checkSavedSession = () => {
                    const backup = localStorage.getItem('qc_backup_session');
                    if (backup) {
                        hasSavedSession.value = true;
                    }
                };

                const restoreSession = () => {
                    try {
                        const backup = JSON.parse(localStorage.getItem('qc_backup_session'));
                        if (backup) {
                            Object.assign(qcState, backup.state);
                            qcData.items = backup.items;
                            if (backup.currentItemIndex >= 0 && qcData.items[backup.currentItemIndex]) {
                                currentItem.value = qcData.items[backup.currentItemIndex];
                            }
                            hasSavedSession.value = false;
                            Swal.fire({ icon: 'success', title: 'Session Restored', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false });
                        }
                    } catch (e) {
                        console.error('Failed to restore', e);
                    }
                };

                const clearSavedSession = () => {
                    localStorage.removeItem('qc_backup_session');
                    hasSavedSession.value = false;
                    // Reset current
                    if(qcState.step === 'working') {
                        Swal.fire({
                            title: 'Clear Data?',
                            text: 'This will reset your current workspace.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, Clear'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                qcState.step = 'upload';
                                qcData.items = [];
                                currentItem.value = null;
                            }
                        });
                    }
                };

                // 1. Auth
                const handleLogin = async () => {
                    loading.value = true;
                    try {
                        const { data, error } = await sb
                            .from('app_users')
                            .select('*')
                            .eq('username', loginForm.username)
                            .eq('password', loginForm.password)
                            .single();
                        
                        if (error || !data) throw new Error('Invalid credentials');

                        user.value = data;
                        localStorage.setItem('qc_user', JSON.stringify(data));
                        fetchSettings();
                        Swal.fire({ icon: 'success', title: 'Welcome back!', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
                    } catch (e) {
                        Swal.fire('Error', e.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const handleLogout = () => {
                    user.value = null;
                    localStorage.removeItem('qc_user');
                    qcState.step = 'upload';
                    qcData.items = [];
                };

                // 2. QC Flow
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    processCSV(file);
                };

                const handleDrop = (e) => {
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        processCSV(file);
                    }
                };

                const processCSV = (file) => {
                    loading.value = true;
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: async (results) => {
                            const mappedItems = results.data.map((row, index) => ({
                                id_temp: index, 
                                job_name: row['ชื่อใบงาน'],
                                bill_no: row['เลขบิล'],
                                uid: row['Item UID'],
                                product_name: row['ชื่อสินค้า'],
                                ink_color: row['สีหมึก'],
                                floor: row['ชั้นที่'],
                                cartoon_name: row['ลายการ์ตูน'],
                                line_art: row['ลายเส้น'],
                                font: row['ฟอนต์'],
                                line1: row['บรรทัด 1'],
                                line2: row['บรรทัด 2'],
                                line3: row['บรรทัด 3'],
                                qty: row['จำนวน'],
                                remark: row['หมายเหตุ'],
                                status: 'pending',
                                scanned: false
                            }));

                            qcData.items = mappedItems;
                            qcState.filename = file.name;
                            qcState.startTime = new Date();
                            qcState.step = 'working';

                            const { data, error } = await sb
                                .from('qc_sessions')
                                .insert({
                                    // user_id: user.value.id, // Removed to avoid UUID mismatch
                                    username: user.value.username,
                                    filename: file.name,
                                    start_time: qcState.startTime,
                                    total_items: totalItems.value
                                })
                                .select()
                                .single();
                            
                            if (error) {
                                console.error('Session Create Error:', error);
                                Swal.fire('Error', 'Failed to create session. Check DB Logs/RLS.', 'error');
                            } else if (data) {
                                qcState.sessionId = data.id;
                            }
                            
                            loading.value = false;
                            nextTick(() => barcodeInput.value?.focus());
                        }
                    });
                };

                const handleScan = () => {
                    const uid = barcodeQuery.value.trim();
                    if (!uid) return;

                    const foundItem = qcData.items.find(i => i.uid === uid);
                    if (foundItem) {
                        selectItem(foundItem);
                        barcodeQuery.value = ''; 
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Item Not Found',
                            text: `UID: ${uid} is not in this file`,
                            timer: 1500,
                            showConfirmButton: false
                        });
                        barcodeQuery.value = '';
                    }
                };

                const selectItem = (item) => {
                    currentItem.value = item;
                    item.scanned = true;
                };

                const navigateItem = (dir) => {
                    if (!qcData.items.length) return;
                    let idx = currentItem.value ? qcData.items.indexOf(currentItem.value) : -1;
                    let nextIdx = idx + dir;
                    
                    if (nextIdx >= 0 && nextIdx < qcData.items.length) {
                        selectItem(qcData.items[nextIdx]);
                    }
                };

                const markStatus = async (status) => {
                    if (!currentItem.value) return;

                    let failReason = null;

                    if (status === 'fail') {
                        // Use a fallback if settingsData.reasons is empty
                        const options = settingsData.reasons.length > 0 
                            ? settingsData.reasons.reduce((acc, cur) => ({...acc, [cur.reason_text]: cur.reason_text}), {})
                            : { 'Defect': 'Defect', 'Wrong Color': 'Wrong Color', 'Wrong Text': 'Wrong Text' };

                        const { value: reason } = await Swal.fire({
                            title: 'Select Fail Reason',
                            input: 'select',
                            inputOptions: options,
                            inputPlaceholder: 'Select a reason',
                            showCancelButton: true,
                            inputValidator: (value) => {
                                if (!value) return 'You need to choose something!'
                            }
                        });

                        if (reason) {
                            failReason = reason;
                        } else {
                            return; 
                        }
                    }

                    currentItem.value.status = status;
                    if (failReason) currentItem.value.fail_reason = failReason;
                    saveRecord(currentItem.value);
                    navigateItem(1);
                };

                const saveRecord = async (item) => {
                    if (!qcState.sessionId) return;
                    await sb.from('qc_records').insert({
                        session_id: qcState.sessionId,
                        item_uid: item.uid,
                        qc_by: user.value.username,
                        status: item.status,
                        fail_reason: item.fail_reason || null,
                        details_json: item
                    });
                };

                const finishSession = async () => {
                    const confirm = await Swal.fire({
                        title: 'Finish QC Job?',
                        text: "This will calculate KPI and close the session.",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Finish',
                        confirmButtonColor: '#D4AF37'
                    });

                    if (confirm.isConfirmed) {
                        loading.value = true;
                        const endTime = new Date();
                        const durationSec = (endTime - new Date(qcState.startTime)) / 1000;
                        const kpi = durationSec / totalItems.value;

                        await sb.from('qc_sessions')
                            .update({
                                end_time: endTime,
                                pass_count: passedItems.value,
                                fail_count: failedItems.value,
                                kpi_score: kpi
                            })
                            .eq('id', qcState.sessionId);

                        // Clear backup
                        localStorage.removeItem('qc_backup_session');
                        loading.value = false;
                        
                        Swal.fire('Success', `Job Finished! KPI: ${kpi.toFixed(2)} sec/item`, 'success').then(() => {
                            qcState.step = 'upload';
                            qcData.items = [];
                            currentItem.value = null;
                        });
                    }
                };

                // 3. Helper Logic
                const getPublicUrl = (bucket, filename) => {
                    // Supabase handles UTF-8 paths, but we need to ensure special chars are safe in URL
                    const { data } = sb.storage.from(bucket).getPublicUrl(filename);
                    return data.publicUrl;
                };

                const handleImageError = (event, type) => {
                    const img = event.target;
                    const src = img.src;
                    
                    if (img.dataset.triedPng) {
                        img.style.display = 'none';
                        // Show parent's placeholder div
                        if(img.parentElement.querySelector('div.text-gray-400')) {
                             img.parentElement.querySelector('div.text-gray-400').style.display = 'flex';
                        }
                        return;
                    }

                    if (src.endsWith('.jpg')) {
                        img.dataset.triedPng = "true";
                        img.src = src.replace('.jpg', '.png');
                    } else if (src.endsWith('.png')) {
                        img.dataset.triedPng = "true";
                        img.src = ''; 
                    } else {
                        img.src = src + '.jpg';
                    }
                };

                const getInkColor = (inkName) => {
                    if (!inkName) return 'transparent';
                    const found = settingsData.ink.find(i => i.ink_name === inkName);
                    return found ? found.hex_code : '#CCCCCC'; 
                };

                const formatDate = (dateString) => {
                    if (!dateString) return '-';
                    return new Date(dateString).toLocaleString('th-TH');
                };

                // 4. Settings / Admin
                const fetchSettings = async () => {
                    // Parallel fetch
                    const [u, r, i] = await Promise.all([
                        sb.from('app_users').select('*'),
                        sb.from('settings_reasons').select('*'),
                        sb.from('settings_ink').select('*')
                    ]);
                    
                    if(u.data) settingsData.users = u.data;
                    if(r.data) settingsData.reasons = r.data; // Ensure this array is populated
                    if(i.data) settingsData.ink = i.data;
                };

                const addUser = async () => {
                    if(!newUser.username || !newUser.password) return;
                    const { error } = await sb.from('app_users').insert({...newUser});
                    if(error) handleError(error);
                    else {
                        newUser.username = ''; newUser.password = '';
                        fetchSettings();
                    }
                };
                const deleteUser = async (id) => {
                    await sb.from('app_users').delete().eq('id', id);
                    fetchSettings();
                };

                const addReason = async () => {
                    if(!newReason.value) return;
                    const { error } = await sb.from('settings_reasons').insert({ reason_text: newReason.value });
                    if(error) handleError(error);
                    else {
                        newReason.value = '';
                        fetchSettings();
                    }
                };
                const deleteReason = async (id) => {
                    await sb.from('settings_reasons').delete().eq('id', id);
                    fetchSettings();
                };

                const addInk = async () => {
                    if(!newInk.name) return;
                    await sb.from('settings_ink').insert({ ink_name: newInk.name, hex_code: newInk.hex });
                    newInk.name = '';
                    fetchSettings();
                };
                const deleteInk = async (id) => {
                    await sb.from('settings_ink').delete().eq('id', id);
                    fetchSettings();
                };

                const uploadImages = async () => {
                    const files = imageUploader.value.files;
                    if(!files || files.length === 0) return;

                    loading.value = true;
                    let successCount = 0;
                    let failCount = 0;

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        // Use original filename (Supabase supports UTF-8/Thai)
                        const finalName = file.name;

                        const { data, error } = await sb.storage
                            .from(uploadBucket.value)
                            .upload(finalName, file, { 
                                upsert: true,
                                contentType: file.type // Ensure correct mime type
                            });

                        if(error) {
                            console.error(error);
                            failCount++;
                        } else {
                            successCount++;
                        }
                    }

                    loading.value = false;
                    if(failCount > 0) {
                        Swal.fire('Completed with Errors', `Uploaded: ${successCount}, Failed: ${failCount}. \nCheck Supabase Policy.`, 'warning');
                    } else {
                        Swal.fire('Success', `Uploaded ${successCount} files successfully`, 'success');
                    }
                };

                const handleError = (error) => {
                    console.error(error);
                    if(error.message.includes('row-level security')) {
                        Swal.fire('Permission Denied', 'Database RLS Policy blocked this action. Please check "Insert" permissions in Supabase.', 'error');
                    } else {
                        Swal.fire('Error', error.message, 'error');
                    }
                };

                // Report Functions
                const fetchReports = async () => {
                    loading.value = true;
                    try {
                        let query = sb.from('qc_sessions').select('*').order('created_at', { ascending: false });

                        // Apply filter only if date is selected
                        if (reportFilter.date) {
                             const dateStr = reportFilter.date; // YYYY-MM-DD
                             // Construct full range covering the whole day in UTC context approx
                             const start = dateStr + 'T00:00:00';
                             const end = dateStr + 'T23:59:59';
                             query = query.gte('created_at', start).lte('created_at', end);
                        }

                        const { data, error } = await query;
                        if (!error) reports.value = data;
                        else console.error('Report fetch error:', error);
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                const downloadReport = async (session) => {
                    const { data } = await sb.from('qc_records').select('*').eq('session_id', session.id);
                    if (!data) return;
                    const csv = Papa.unparse(data.map(r => ({
                        ItemUID: r.item_uid,
                        Status: r.status,
                        Reason: r.fail_reason || '',
                        QC_By: r.qc_by,
                        Timestamp: new Date(r.created_at).toLocaleString()
                    })));
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `QC_${session.filename}.csv`;
                    link.click();
                };

                const searchHistory = async () => {
                    if (!historySearch.value) return;
                    loading.value = true;
                    historySearched.value = true;
                    // Ensure trim to match exactly
                    const { data, error } = await sb.from('qc_records').select('*').eq('item_uid', historySearch.value.trim()).order('created_at', { ascending: false });
                    if (!error) historyResults.value = data;
                    loading.value = false;
                };

                const generateFavicon = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 64; canvas.height = 64;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#D4AF37'; ctx.beginPath(); ctx.arc(32, 32, 32, 0, 2 * Math.PI); ctx.fill();
                    ctx.font = 'bold 30px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('QC', 32, 32);
                    const link = document.createElement('link');
                    link.type = 'image/x-icon'; link.rel = 'shortcut icon'; link.href = canvas.toDataURL();
                    document.getElementsByTagName('head')[0].appendChild(link);
                };

                return {
                    loading, user, isLoggedIn, isAdmin, currentView, viewTitle,
                    isSidebarOpen, loginForm, handleLogin, handleLogout,
                    qcState, qcData, currentItem, remainingItems, totalItems, passedItems, failedItems,
                    barcodeQuery, barcodeInput, handleFileUpload, handleDrop, handleScan,
                    productImageUrl, cartoonImageUrl, getInkColor, handleImageError,
                    selectItem, navigateItem, markStatus, finishSession,
                    reports, reportFilter, fetchReports, downloadReport, formatDate,
                    historySearch, historyResults, historySearched, searchHistory,
                    settingsTab, settingsData, newUser, newReason, newInk, uploadBucket, imageUploader,
                    addUser, deleteUser, addReason, deleteReason, addInk, deleteInk, uploadImages,
                    hasSavedSession, restoreSession, clearSavedSession
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
