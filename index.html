<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Luxury System V.4.1</title>

    <!-- Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- PapaParse (CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: {
                        gold: { 400: '#EBC76D', 500: '#D4AF37', 600: '#B59428' },
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F3F4F6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }
        .h-main-content { height: calc(100vh - 80px); }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .z-modal-backdrop { z-index: 9998; }
        .z-modal-content { z-index: 9999; }
        .items-list-container { scroll-behavior: smooth; }
    </style>
</head>
<body id="app" class="text-gray-700 antialiased h-screen overflow-hidden flex">

    <!-- Loading Overlay -->
    <div v-if="loading" class="fixed inset-0 z-[10000] flex items-center justify-center bg-white bg-opacity-80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-gold-500 mb-2"></i>
            <span class="text-gold-600 font-bold uppercase tracking-wider">Processing...</span>
        </div>
    </div>

    <!-- Login Section -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[150] flex items-center justify-center bg-gray-100">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border-t-4 border-gold-500 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gold-500 text-white text-2xl font-bold mb-4 shadow-lg">QC</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-6 uppercase">Quality Control System</h1>
            <form @submit.prevent="handleLogin" class="space-y-4">
                <input v-model="loginForm.username" type="text" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-gold-400 outline-none" placeholder="Username" required>
                <input v-model="loginForm.password" type="password" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-gold-400 outline-none" placeholder="Password" required>
                <button type="submit" class="w-full py-3 rounded-lg bg-gold-500 text-white font-bold hover:bg-gold-600 transition shadow-lg uppercase">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main Sidebar and Content -->
    <div v-else class="flex w-full h-full">
        <aside :class="['bg-white shadow-xl flex flex-col z-30 transition-all duration-300', isSidebarOpen ? 'w-64' : 'w-20 hidden md:flex']">
            <div class="h-20 flex items-center justify-center border-b border-gray-100 shrink-0">
                <div class="w-10 h-10 rounded-full bg-gold-500 flex items-center justify-center text-white font-bold shadow-md">QC</div>
                <span v-if="isSidebarOpen" class="font-bold text-xl ml-2 text-gray-800 uppercase">LUX<span class="text-gold-500">QC</span></span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 px-2 space-y-1">
                <button v-for="menu in menus" :key="menu.id" @click="currentView = menu.id" 
                    :class="['w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all relative', currentView === menu.id ? 'bg-gold-500 text-white shadow-lg' : 'text-gray-500 hover:bg-gray-50 hover:text-gold-500']">
                    <i :class="['fas text-lg w-6 text-center', menu.icon]"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">{{ menu.label }}</span>
                    <!-- Reject Badge -->
                    <span v-if="menu.id === 'reject' && rejectTotalCount > 0" class="absolute right-2 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">
                        {{ rejectTotalCount }}
                    </span>
                </button>
            </nav>
            <div class="p-4 border-t border-gray-100 shrink-0">
                <button @click="handleLogout" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-red-400 hover:bg-red-50 hover:text-red-500 transition-colors uppercase">
                    <i class="fas fa-sign-out-alt text-lg w-6 text-center"></i>
                    <span v-if="isSidebarOpen" class="font-medium text-sm">Sign Out</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full bg-[#F8F9FA] relative overflow-hidden">
            <header class="h-20 bg-white shadow-sm flex items-center justify-between px-6 z-20 shrink-0">
                <div class="flex items-center gap-4">
                    <button @click="isSidebarOpen = !isSidebarOpen" class="text-gray-400 hover:text-gold-500"><i class="fas fa-bars text-xl"></i></button>
                    <h2 class="text-xl font-bold text-gray-800 uppercase">{{ viewTitle }}</h2>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs text-gray-400 font-bold uppercase">User</div>
                        <div class="font-semibold text-gray-700 font-bold uppercase leading-none">{{ user?.username }}</div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gray-100 border-2 border-gold-400 flex items-center justify-center text-gold-500 shadow-inner"><i class="fas fa-user"></i></div>
                </div>
            </header>

            <div class="flex-1 overflow-hidden p-3 relative h-main-content">
                
                <!-- View: QC Operation -->
                <div v-if="currentView === 'qc'" class="h-full flex flex-col">
                    <div v-if="qcState.step === 'upload'" class="flex-1 flex flex-col items-center justify-center">
                        <div class="border-2 border-dashed border-gray-300 rounded-3xl p-12 bg-white hover:border-gold-500 cursor-pointer text-center group transition shadow-sm" @click="$refs.fileInput.click()" @dragover.prevent @drop.prevent="handleDrop">
                            <input type="file" ref="fileInput" class="hidden" accept=".csv" @change="handleFileUpload">
                            <div class="w-20 h-20 bg-gold-50 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition duration-300">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gold-500"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-700 mb-2 uppercase">Upload Production File</h3>
                            <p class="text-gray-400 font-medium tracking-wide">Click to browse or drag file here</p>
                        </div>

                        <!-- Session Restore UI -->
                        <div v-if="hasSavedSession" class="mt-8 flex gap-5 bg-blue-50 p-6 rounded-2xl border border-blue-200 items-center animate-bounce shadow-sm">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white text-xl">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-blue-900 font-bold block">พบข้อมูลการทำงานที่ค้างอยู่</span>
                                <span class="text-blue-700 text-sm italic">{{ savedSessionInfo?.filename }}</span>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button @click="restoreSession" class="px-5 py-2 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition uppercase text-sm">Restore</button>
                                <button @click="clearBackupPrompt" class="px-5 py-2 text-red-500 hover:bg-red-50 rounded-xl font-bold transition uppercase text-sm border border-red-200">Discard</button>
                            </div>
                        </div>
                    </div>

                    <div v-if="qcState.step === 'working'" class="flex flex-col h-full gap-2">
                        <div class="bg-white p-2 rounded-xl shadow-sm flex items-center justify-between shrink-0 h-20 px-4 relative">
                            <div class="w-64 hidden md:block"></div> 
                            <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex gap-10 items-center">
                                <div class="text-center"><span class="text-xs text-gray-400 uppercase font-bold tracking-wider leading-none">Total</span><div class="font-bold text-3xl text-gray-700 leading-none mt-1">{{ totalItems }}</div></div>
                                <div class="text-center"><span class="text-xs text-gray-400 uppercase font-bold tracking-wider leading-none">Pass</span><div class="font-bold text-3xl text-green-500 leading-none mt-1">{{ passedItems }}</div></div>
                                <div class="text-center"><span class="text-xs text-gray-400 uppercase font-bold tracking-wider leading-none">Fail</span><div class="font-bold text-3xl text-red-500 leading-none mt-1">{{ failedItems }}</div></div>
                                <div class="text-center"><span class="text-xs text-gray-400 uppercase font-bold tracking-wider leading-none">Left</span><div class="font-bold text-3xl text-gold-500 leading-none mt-1">{{ remainingItems }}</div></div>
                            </div>
                            <div class="flex gap-3 items-center ml-auto z-10">
                                <div class="relative"><i class="fas fa-barcode absolute left-3 top-2.5 text-gray-400"></i><input ref="barcodeInput" v-model="barcodeQuery" @keyup.enter="handleScan" class="pl-9 pr-4 py-1.5 border rounded-lg focus:ring-2 focus:ring-gold-500 outline-none w-64 font-bold uppercase" placeholder="Scan UID"></div>
                                <button v-if="remainingItems === 0" @click="finishSession" class="px-6 py-1.5 bg-gold-500 text-white rounded-lg font-bold shadow animate-pulse uppercase tracking-wider">FINISH JOB</button>
                            </div>
                        </div>

                        <div class="flex-1 flex gap-3 overflow-hidden">
                            <div class="w-[260px] bg-white rounded-xl shadow-sm flex flex-col shrink-0">
                                <div class="p-3 border-b bg-gray-50 text-xs font-bold text-gray-600 uppercase tracking-wide">Items List</div>
                                <div class="flex-1 overflow-y-auto p-1 space-y-1 items-list-container" ref="itemsList">
                                    <div v-for="(item, index) in qcData.items" :key="item.uid" :id="'item-' + item.uid" @click="selectItem(item)" 
                                        :class="['p-2 rounded border cursor-pointer flex justify-between items-center text-xs transition', item === currentItem ? 'border-gold-500 bg-yellow-50 ring-1 ring-gold-500' : 'border-gray-100 hover:bg-gray-50']">
                                        <div class="flex items-start gap-2 overflow-hidden text-left">
                                            <span class="text-[10px] font-bold text-gray-400 w-5 shrink-0 mt-0.5">{{ index + 1 }}.</span>
                                            <div class="truncate w-36 font-medium text-gray-700 uppercase">
                                                {{ item.uid }}<br>
                                                <span class="text-gray-400 font-normal text-[10px]">{{ item.product_name }}</span>
                                            </div>
                                        </div>
                                        <i v-if="item.status === 'pass'" class="fas fa-check-circle text-green-500 text-sm"></i>
                                        <i v-else-if="item.status === 'fail'" class="fas fa-times-circle text-red-500 text-sm"></i>
                                        <i v-else class="far fa-circle text-gray-300 text-sm"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="w-[450px] shrink-0 flex flex-col gap-2 h-full">
                                <div class="h-1/2 bg-white rounded-xl shadow-sm border flex items-center justify-center relative overflow-hidden group text-center cursor-pointer" @click="openInNewTab(productImageUrl)">
                                    <img v-if="productImageUrl && !imgErrors.product" :src="productImageUrl" @error="handleImageError('product')" class="object-contain w-full h-full p-4 transition-transform group-hover:scale-105 duration-500">
                                    <div v-else class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 flex-col">
                                        <i class="fas fa-image text-3xl mb-2"></i><div class="text-xs font-bold uppercase">No Image</div>
                                    </div>
                                    <span class="absolute top-3 left-3 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm uppercase">Product: {{ currentItem?.product_code || '-' }}</span>
                                </div>
                                <div class="h-1/2 bg-white rounded-xl shadow-sm border flex items-center justify-center relative overflow-hidden group text-center cursor-pointer" @click="openInNewTab(cartoonImageUrl)">
                                    <img v-if="cartoonImageUrl && !imgErrors.cartoon" :src="cartoonImageUrl" @error="handleImageError('cartoon')" class="object-contain w-full h-full p-4 transition-transform group-hover:scale-105 duration-500">
                                    <div v-else class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 flex-col">
                                        <i class="fas fa-shapes text-3xl mb-2"></i><div class="text-xs font-bold uppercase">No Pattern</div>
                                    </div>
                                    <span class="absolute top-3 left-3 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm uppercase">Pattern: {{ currentItem?.cartoon_name || '-' }}</span>
                                </div>
                            </div>

                            <div class="flex-1 bg-white rounded-xl shadow-sm p-4 overflow-hidden flex flex-col relative text-left">
                                <div v-if="currentItem" class="flex flex-col h-full">
                                    <div class="border-b pb-3 mb-3 flex justify-between items-start shrink-0">
                                        <div class="overflow-hidden pr-4 text-left">
                                            <h2 class="text-2xl font-bold text-gray-800 leading-tight mb-1 uppercase">{{ currentItem.product_name }}</h2>
                                            <p class="text-xs text-gray-500 font-bold uppercase tracking-tight">Bill: {{ currentItem.bill_no }}</p>
                                        </div>
                                        <div class="text-right shrink-0 font-mono">
                                            <div class="text-[10px] text-gray-400 uppercase font-bold leading-none">UID</div>
                                            <div class="text-2xl font-bold text-gold-600 leading-none mt-1 uppercase">{{ currentItem.uid }}</div>
                                        </div>
                                    </div>

                                    <div class="flex-1 overflow-y-auto pr-1 space-y-4">
                                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                            <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-2 font-bold text-left leading-none">Text Details</div>
                                            <div class="text-2xl font-bold text-gray-800 mb-2 border-b border-gray-200 pb-2">{{ currentItem.line1 || '-' }}</div>
                                            <div class="text-2xl font-bold text-gray-800 mb-2 border-b border-gray-200 pb-2">{{ currentItem.line2 || '-' }}</div>
                                            <div class="text-2xl font-bold text-gray-800">{{ currentItem.line3 || '-' }}</div>
                                        </div>

                                        <div class="grid grid-cols-3 gap-3">
                                            <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                                <div class="text-base text-gray-400 mb-1 font-bold uppercase">Ink Color</div>
                                                <div class="flex items-center gap-3">
                                                    <span class="w-10 h-10 rounded-full border border-gray-200 shadow-sm shrink-0" :style="{ backgroundColor: getInkColor(currentItem.ink_color) }"></span>
                                                    <span class="text-xl font-bold text-gray-700 truncate leading-tight uppercase">{{ currentItem.ink_color || '-' }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                                <div class="text-base text-gray-400 mb-1 font-bold uppercase">Font</div>
                                                <div class="text-xl font-bold text-gray-700 truncate leading-tight uppercase">{{ currentItem.font || '-' }}</div>
                                            </div>
                                            <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                                <div class="text-base text-gray-400 mb-1 font-bold text-left uppercase">Qty</div>
                                                <div class="text-3xl font-bold text-gray-800 leading-tight">{{ currentItem.qty || 1 }} <span class="text-sm font-normal text-gray-400 uppercase">pcs</span></div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-4 gap-3">
                                            <div class="col-span-1 bg-white p-3 rounded-lg border shadow-sm">
                                                <div class="text-base text-gray-400 mb-1 font-bold uppercase">Floor</div>
                                                <div class="text-2xl font-bold text-gray-800 leading-tight uppercase">{{ currentItem.floor || '-' }}</div>
                                            </div>
                                            <div class="col-span-3 bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-yellow-900 shadow-sm flex gap-3 items-start overflow-hidden text-left">
                                                <i class="fas fa-exclamation-circle text-yellow-600 mt-1 text-lg"></i>
                                                <div class="overflow-hidden">
                                                    <span class="font-bold text-base block uppercase">Remark:</span> 
                                                    <span class="text-lg truncate block font-medium uppercase" :title="currentItem.remark">{{ currentItem.remark || '-' }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3 pt-3 border-t flex flex-col gap-3 shrink-0 font-bold">
                                        <div class="flex gap-4 h-16 uppercase">
                                            <button @click="markStatus('fail')" class="flex-1 bg-white border-4 border-red-500 text-red-500 text-2xl rounded-xl hover:bg-red-50 transition shadow-sm flex items-center justify-center gap-2">
                                                <i class="fas fa-times"></i> FAIL
                                            </button>
                                            <button @click="markStatus('pass')" class="flex-1 bg-green-500 text-white text-2xl rounded-xl hover:bg-green-600 transition shadow-lg flex items-center justify-center gap-2">
                                                <i class="fas fa-check"></i> PASS
                                            </button>
                                        </div>
                                        <div class="flex justify-between items-center gap-4 h-16 uppercase text-xl">
                                            <button @click="navigateItem(-1)" class="flex-1 h-full bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl flex items-center justify-center gap-2 border border-gray-200 transition">
                                                <i class="fas fa-chevron-left"></i> Prev
                                            </button>
                                            <button @click="navigateItem(1)" class="flex-1 h-full bg-gold-500 hover:bg-gold-600 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg transition">
                                                Next <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="h-full flex flex-col items-center justify-center text-gray-300">
                                    <i class="fas fa-qrcode text-8xl mb-4 opacity-30"></i>
                                    <p class="text-xl font-medium text-gray-400 uppercase tracking-widest">Scan Barcode to Start</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Reject Management -->
                <div v-else-if="currentView === 'reject'" class="h-full flex flex-col">
                    <div class="bg-white p-2 rounded-xl shadow-sm flex items-center justify-between shrink-0 h-20 px-4 relative mb-2">
                        <div class="flex gap-10 items-center">
                            <div class="text-center bg-red-50 px-6 py-2 rounded-xl border border-red-100">
                                <span class="text-xs text-red-400 uppercase font-bold tracking-wider leading-none">Reject Total Pending</span>
                                <div class="font-bold text-3xl text-red-500 leading-none mt-1">{{ rejectTotalCount }}</div>
                            </div>
                        </div>
                        <div class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 flex gap-1 bg-gray-50 p-1 rounded-xl border shadow-inner">
                            <button v-for="n in 6" :key="n" @click="activeRejectTab = n" 
                                :class="['px-4 py-2 rounded-lg font-bold text-sm transition-all', activeRejectTab === n ? 'bg-gold-500 text-white shadow' : 'text-gray-400 hover:text-gold-500']">
                                REJECT {{ n }} 
                                <span class="ml-1 text-[10px] opacity-70">({{ getRejectCountByTab(n) }})</span>
                            </button>
                        </div>
                        <div class="flex gap-3 items-center z-10">
                            <div class="relative"><i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i><input v-model="rejectSearchQuery" @keyup.enter="handleRejectScan" class="pl-9 pr-4 py-1.5 border rounded-lg focus:ring-2 focus:ring-gold-500 outline-none w-64 font-bold uppercase" placeholder="Search UID in Tab"></div>
                            <button @click="fetchRejectItems" class="p-2 bg-gray-100 text-gray-500 rounded-lg hover:bg-gold-500 hover:text-white transition shadow-sm"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>

                    <div class="flex-1 flex gap-3 overflow-hidden">
                        <div class="w-[260px] bg-white rounded-xl shadow-sm flex flex-col shrink-0">
                            <div class="p-3 border-b bg-gray-50 text-xs font-bold text-gray-600 uppercase tracking-wide">Reject List (Step {{ activeRejectTab }})</div>
                            <div class="flex-1 overflow-y-auto p-1 space-y-1 items-list-container">
                                <div v-for="(item, index) in filteredRejectItems" :key="item.id" @click="currentRejectItem = item" 
                                    :class="['p-2 rounded border cursor-pointer flex justify-between items-center text-xs transition', item === currentRejectItem ? 'border-gold-500 bg-yellow-50 ring-1 ring-gold-500' : 'border-gray-100 hover:bg-gray-50']">
                                    <div class="flex items-start gap-2 overflow-hidden text-left">
                                        <span class="text-[10px] font-bold text-gray-400 w-5 shrink-0 mt-0.5">{{ index + 1 }}.</span>
                                        <div class="truncate w-36 font-medium text-gray-700 uppercase">
                                            {{ item.item_uid }}<br>
                                            <span class="text-gray-400 font-normal text-[10px]">{{ item.product_name }}</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-exclamation-circle text-red-300 text-sm"></i>
                                </div>
                                <div v-if="filteredRejectItems.length === 0" class="text-center py-10 text-gray-300 italic text-xs uppercase">No items found</div>
                            </div>
                        </div>

                        <div class="w-[450px] shrink-0 flex flex-col gap-2 h-full">
                            <div class="h-1/2 bg-white rounded-xl shadow-sm border flex items-center justify-center relative overflow-hidden group text-center cursor-pointer" @click="openInNewTab(getPublicUrl('Product_Pic', currentRejectItem.product_code, '.jpg'))">
                                <img v-if="currentRejectItem && !imgErrors.product" :src="getPublicUrl('Product_Pic', currentRejectItem.product_code, '.jpg')" @error="handleImageError('product')" class="object-contain w-full h-full p-4 transition-transform group-hover:scale-105 duration-500">
                                <div v-else class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 flex-col"><i class="fas fa-image text-3xl mb-2"></i><div class="text-xs font-bold uppercase">No Image</div></div>
                                <span class="absolute top-3 left-3 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm uppercase">Product: {{ currentRejectItem?.product_code || '-' }}</span>
                            </div>
                            <div class="h-1/2 bg-white rounded-xl shadow-sm border flex items-center justify-center relative overflow-hidden group text-center cursor-pointer" @click="openInNewTab(getPublicUrl('Cartoon_Pic', currentRejectItem.cartoon_name, '.jpg'))">
                                <img v-if="currentRejectItem && !imgErrors.cartoon" :src="getPublicUrl('Cartoon_Pic', currentRejectItem.cartoon_name, '.jpg')" @error="handleImageError('cartoon')" class="object-contain w-full h-full p-4 transition-transform group-hover:scale-105 duration-500">
                                <div v-else class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 flex-col"><i class="fas fa-shapes text-3xl mb-2"></i><div class="text-xs font-bold uppercase">No Pattern</div></div>
                                <span class="absolute top-3 left-3 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-sm uppercase">Pattern: {{ currentRejectItem?.cartoon_name || '-' }}</span>
                            </div>
                        </div>

                        <div class="flex-1 bg-white rounded-xl shadow-sm p-4 overflow-hidden flex flex-col relative text-left">
                            <div v-if="currentRejectItem" class="flex flex-col h-full">
                                <div class="border-b pb-3 mb-3 flex justify-between items-start shrink-0">
                                    <div class="overflow-hidden pr-4 text-left">
                                        <h2 class="text-2xl font-bold text-gray-800 leading-tight mb-1 uppercase">{{ currentRejectItem.product_name }}</h2>
                                        <p class="text-xs text-gray-500 font-bold uppercase tracking-tight">Bill: {{ currentRejectItem.bill_no }}</p>
                                    </div>
                                    <div class="text-right shrink-0 font-mono">
                                        <div class="text-[10px] text-gray-400 uppercase font-bold leading-none">UID</div>
                                        <div class="text-2xl font-bold text-gold-600 leading-none mt-1 uppercase">{{ currentRejectItem.item_uid }}</div>
                                    </div>
                                </div>

                                <div class="flex-1 overflow-y-auto pr-1 space-y-4">
                                    <div class="bg-red-50 p-3 rounded-lg border border-red-100 mb-2">
                                        <span class="text-[10px] font-bold text-red-400 uppercase block mb-1">Previous Fail Reason</span>
                                        <p class="text-lg font-bold text-red-600 uppercase">{{ currentRejectItem.fail_reason || '-' }}</p>
                                    </div>

                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                        <div class="text-[10px] text-gray-400 uppercase tracking-wider mb-2 font-bold text-left leading-none">Text Details</div>
                                        <div class="text-2xl font-bold text-gray-800 mb-2 border-b border-gray-200 pb-2">{{ currentRejectItem.line1 || '-' }}</div>
                                        <div class="text-2xl font-bold text-gray-800 mb-2 border-b border-gray-200 pb-2">{{ currentRejectItem.line2 || '-' }}</div>
                                        <div class="text-2xl font-bold text-gray-800">{{ currentRejectItem.line3 || '-' }}</div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-3">
                                        <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                            <div class="text-base text-gray-400 mb-1 font-bold uppercase">Ink Color</div>
                                            <div class="flex items-center gap-3">
                                                <span class="w-10 h-10 rounded-full border border-gray-200 shadow-sm shrink-0" :style="{ backgroundColor: getInkColor(currentRejectItem.ink_color) }"></span>
                                                <span class="text-xl font-bold text-gray-700 truncate leading-tight uppercase">{{ currentRejectItem.ink_color || '-' }}</span>
                                            </div>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                            <div class="text-base text-gray-400 mb-1 font-bold uppercase">Font</div>
                                            <div class="text-xl font-bold text-gray-700 truncate leading-tight uppercase">{{ currentRejectItem.font || '-' }}</div>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg border shadow-sm flex flex-col justify-center">
                                            <div class="text-base text-gray-400 mb-1 font-bold text-left uppercase">Qty</div>
                                            <div class="text-3xl font-bold text-gray-800 leading-tight">{{ currentRejectItem.qty || 1 }} <span class="text-sm font-normal text-gray-400 uppercase">pcs</span></div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="bg-white p-3 rounded-lg border shadow-sm">
                                            <div class="text-base text-gray-400 mb-1 font-bold uppercase">Floor</div>
                                            <div class="text-2xl font-bold text-gray-800 leading-tight uppercase">{{ currentRejectItem.floor || '-' }}</div>
                                        </div>
                                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-yellow-900 shadow-sm flex gap-3 items-start overflow-hidden text-left">
                                            <i class="fas fa-exclamation-circle text-yellow-600 mt-1 text-lg"></i>
                                            <div class="overflow-hidden">
                                                <span class="font-bold text-base block uppercase">Remark:</span> 
                                                <span class="text-lg truncate block font-medium uppercase" :title="currentRejectItem.remark">{{ currentRejectItem.remark || '-' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-3 pt-3 border-t flex flex-col gap-3 shrink-0 font-bold">
                                    <div class="flex gap-4 h-20 uppercase">
                                        <button @click="markRejectStatus('fail')" class="flex-1 bg-white border-4 border-red-500 text-red-500 text-2xl rounded-xl hover:bg-red-50 transition shadow-sm flex items-center justify-center gap-3">
                                            <i class="fas fa-redo-alt"></i> FAIL (NEXT REJECT)
                                        </button>
                                        <button @click="markRejectStatus('pass')" class="flex-1 bg-green-500 text-white text-3xl rounded-xl hover:bg-green-600 transition shadow-lg flex items-center justify-center gap-3">
                                            <i class="fas fa-check-double"></i> QC PASS
                                        </button>
                                    </div>
                                    <!-- Add Prev/Next for Reject -->
                                    <div class="flex justify-between items-center gap-4 h-16 uppercase text-xl">
                                        <button @click="navigateRejectItem(-1)" class="flex-1 h-full bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl flex items-center justify-center gap-2 border border-gray-200 transition">
                                            <i class="fas fa-chevron-left"></i> Prev
                                        </button>
                                        <button @click="navigateRejectItem(1)" class="flex-1 h-full bg-gold-500 hover:bg-gold-600 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg transition">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="h-full flex flex-col items-center justify-center text-gray-300">
                                <i class="fas fa-ban text-8xl mb-4 opacity-30"></i>
                                <p class="text-xl font-medium text-gray-400 uppercase tracking-widest">Select Item to Process</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Reports & KPI -->
                <div v-else-if="currentView === 'report'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-gray-800 uppercase">Performance Reports</h3>
                        <div class="flex flex-wrap gap-2 bg-gray-50 p-2 rounded-lg border items-center">
                             <!-- Start Date -->
                             <div class="flex flex-col">
                                 <span class="text-[10px] font-bold text-gray-400 uppercase ml-1">Start Date</span>
                                 <input type="date" v-model="reportFilter.startDate" class="bg-white border rounded px-2 py-1 outline-none text-gray-600 font-bold uppercase text-xs">
                             </div>
                             <!-- End Date -->
                             <div class="flex flex-col">
                                 <span class="text-[10px] font-bold text-gray-400 uppercase ml-1">End Date</span>
                                 <input type="date" v-model="reportFilter.endDate" class="bg-white border rounded px-2 py-1 outline-none text-gray-600 font-bold uppercase text-xs">
                             </div>
                             <!-- User Select -->
                             <div class="flex flex-col">
                                 <span class="text-[10px] font-bold text-gray-400 uppercase ml-1">QC User</span>
                                 <select v-model="reportFilter.user" class="bg-white border rounded px-2 py-1 outline-none text-gray-600 font-bold uppercase text-xs">
                                     <option value="">ALL USERS</option>
                                     <option v-for="u in settingsData.users" :key="u.username" :value="u.username">{{ u.username }}</option>
                                 </select>
                             </div>
                             <button @click="fetchReports" class="bg-gold-500 text-white px-4 py-2 rounded-md font-bold hover:bg-gold-600 uppercase text-xs mt-auto">Filter</button>
                        </div>
                    </div>
                    <div class="overflow-hidden rounded-lg border shadow-sm">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs uppercase bg-gray-50 text-gray-700 font-bold">
                                <tr>
                                    <th class="px-6 py-3 text-center">เริ่ม QC</th>
                                    <th class="px-6 py-3 text-center">เสร็จสิ้น</th>
                                    <th class="px-6 py-3">User</th>
                                    <th class="px-6 py-3">File</th>
                                    <th class="px-6 py-3 text-center">Total</th>
                                    <th class="px-6 py-3 text-center text-green-600">Pass</th>
                                    <th class="px-6 py-3 text-center text-red-600">Fail</th>
                                    <th class="px-6 py-3 text-center">KPI (วินาที/ชิ้น)</th>
                                    <th class="px-6 py-3 text-center uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="s in reports" :key="s.id" @click="showSessionDetails(s)" class="border-b hover:bg-gold-50 cursor-pointer bg-white transition">
                                    <td class="px-6 py-4 text-center font-medium">{{ formatDate(s.start_time) }}</td>
                                    <td class="px-6 py-4 text-center font-bold text-gold-600">{{ formatDate(s.end_time) }}</td>
                                    <td class="px-6 py-4 font-bold uppercase">{{ s.username }}</td>
                                    <td class="px-6 py-4 truncate max-w-[200px] italic">{{ s.filename }}</td>
                                    <td class="px-6 py-4 text-center font-bold">{{ s.total_items }}</td>
                                    <td class="px-6 py-4 text-center font-bold text-green-600">{{ s.pass_count }}</td>
                                    <td class="px-6 py-4 text-center font-bold text-red-600">{{ s.fail_count }}</td>
                                    <td class="px-6 py-4 text-center"><span class="bg-gray-100 px-2 py-1 rounded font-mono font-bold">{{ (s.kpi_score || 0).toFixed(2) }}</span></td>
                                    <td class="px-6 py-4 text-center">
                                        <button @click.stop="downloadReport(s)" class="text-gold-600 hover:text-gold-800 font-bold uppercase"><i class="fas fa-download mr-1"></i> CSV</button>
                                    </td>
                                </tr>
                                <tr v-if="reports.length === 0"><td colspan="9" class="text-center py-8 text-gray-400 italic font-bold">No records found.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View: History Check -->
                <div v-else-if="currentView === 'history'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto text-left">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-2xl font-bold text-gray-800 uppercase">Item History Check</h3>
                        <div class="relative w-full max-w-lg flex gap-2">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-4 top-3 text-gray-400 font-bold"></i>
                                <input v-model="historySearch" @keyup.enter="searchHistory" type="text" class="w-full pl-12 pr-4 py-2 rounded-full border-2 border-gold-400 focus:ring-4 focus:ring-gold-100 outline-none shadow-sm font-bold uppercase text-sm" placeholder="Scan Barcode or Type UID...">
                            </div>
                            <button @click="searchHistory" class="bg-gold-500 text-white rounded-full px-5 py-2 hover:bg-gold-600 font-bold uppercase text-xs tracking-tight shadow-md transition">Search</button>
                            <!-- New Clear Button -->
                            <button @click="clearHistorySearch" class="bg-gray-200 text-gray-600 rounded-full px-5 py-2 hover:bg-gray-300 font-bold uppercase text-xs tracking-tight shadow-sm transition">Clear</button>
                        </div>
                    </div>
                    
                    <div v-if="historyResults.length > 0" class="space-y-6">
                        <div v-for="(rec, idx) in historyResults" :key="rec.id" class="bg-gray-50 rounded-2xl p-6 border-2 border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                            
                            <div class="flex flex-wrap justify-between items-start gap-4 border-b pb-4 mb-4">
                                <div class="text-left">
                                    <span class="text-gray-400 font-bold text-xl mr-2">#{{ idx + 1 }}</span>
                                    <span class="text-3xl font-black text-gold-600 font-mono tracking-tighter">{{ rec.item_uid }}</span>
                                    <div class="text-sm text-gray-400 font-bold uppercase mt-1">
                                        <i class="far fa-clock mr-1"></i> ตรวจเมื่อ: {{ formatDate(rec.created_at) }} | 
                                        <i class="far fa-user mr-1"></i> โดย: {{ rec.qc_by }}
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="flex gap-2 items-center">
                                        <span class="bg-gold-100 text-gold-700 px-3 py-1 rounded-lg text-sm font-black uppercase">RETRY: {{ rec.retry_count || 1 }}</span>
                                        <div :class="['px-8 py-2 rounded-xl font-black text-2xl uppercase shadow-sm', rec.status==='pass'?'bg-green-500 text-white':'bg-red-500 text-white']">
                                            {{ rec.status }}
                                        </div>
                                    </div>
                                    <div v-if="rec.status === 'fail'" class="text-red-600 font-black text-xl italic uppercase">
                                        <i class="fas fa-exclamation-triangle mr-1"></i> Reason: {{ rec.fail_reason || '-' }}
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                <div class="space-y-4">
                                    <div class="text-left">
                                        <label class="text-xs font-black text-gray-400 uppercase tracking-widest block">Product Name</label>
                                        <div class="text-2xl font-bold text-gray-800 leading-tight">{{ rec.product_name || '-' }}</div>
                                        <div class="text-sm text-gray-500 font-bold flex gap-4 uppercase mt-1">
                                            <span>Code: {{ rec.product_code || '-' }}</span>
                                            <span class="text-gold-600 font-black">Bill: {{ rec.bill_no || '-' }}</span>
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-xl border-2 border-gray-100 text-left">
                                        <label class="text-xs font-black text-gold-600 uppercase tracking-widest block mb-2">Text details</label>
                                        <div class="text-2xl font-black text-gray-700 space-y-1">
                                            <div v-if="rec.line1" class="border-b border-dashed pb-1">1: {{ rec.line1 }}</div>
                                            <div v-if="rec.line2" class="border-b border-dashed pb-1">2: {{ rec.line2 }}</div>
                                            <div v-if="rec.line3">3: {{ rec.line3 }}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-left">
                                    <div class="bg-white p-4 rounded-xl border shadow-sm">
                                        <label class="text-xs font-black text-gray-400 uppercase block mb-1">Ink Color</label>
                                        <div class="text-xl font-black text-gray-700 uppercase flex items-center gap-2">
                                            <div class="w-5 h-5 rounded-full border shadow-inner" :style="{backgroundColor: getInkColor(rec.ink_color)}"></div>
                                            {{ rec.ink_color || '-' }}
                                        </div>
                                    </div>
                                    <div class="bg-white p-4 rounded-xl border shadow-sm">
                                        <label class="text-xs font-black text-gray-400 uppercase block mb-1">Font</label>
                                        <div class="text-xl font-black text-gray-700 uppercase">{{ rec.font || '-' }}</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-xl border shadow-sm">
                                        <label class="text-xs font-black text-gray-400 uppercase block mb-1">Storage Floor</label>
                                        <div class="text-2xl font-black text-gold-600 uppercase">{{ rec.floor || '-' }}</div>
                                    </div>
                                    <div class="bg-white p-4 rounded-xl border shadow-sm">
                                        <label class="text-xs font-black text-gray-400 uppercase block mb-1">Session ID</label>
                                        <div class="text-xl font-bold text-gray-500 uppercase">#{{ rec.session_id }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-6 border-t-2 border-dashed border-gray-200">
                                <label class="text-sm font-black text-gray-400 uppercase tracking-widest block mb-4 text-center">Reference Images</label>
                                <div class="flex flex-wrap justify-center gap-8">
                                    <div class="group">
                                        <div class="w-64 h-64 md:w-80 md:h-80 bg-white border-2 border-gray-200 rounded-3xl overflow-hidden shadow-sm flex items-center justify-center relative hover:border-gold-400 transition-colors cursor-pointer" @click="openInNewTab(getPublicUrl('Product_Pic', rec.product_code, '.jpg'))">
                                            <img :src="getPublicUrl('Product_Pic', rec.product_code, '.jpg')" class="max-w-full max-h-full object-contain p-2 group-hover:scale-110 transition-transform duration-500">
                                            <div class="absolute bottom-0 inset-x-0 bg-black/60 text-white text-[10px] py-1 text-center font-bold uppercase tracking-widest backdrop-blur-sm">Product: {{ rec.product_code }}</div>
                                        </div>
                                    </div>
                                    <div class="group">
                                        <div class="w-64 h-64 md:w-80 md:h-80 bg-white border-2 border-gray-200 rounded-3xl overflow-hidden shadow-sm flex items-center justify-center relative hover:border-gold-400 transition-colors cursor-pointer" @click="openInNewTab(getPublicUrl('Cartoon_Pic', rec.cartoon_name, '.jpg'))">
                                            <img :src="getPublicUrl('Cartoon_Pic', rec.cartoon_name, '.jpg')" class="max-w-full max-h-full object-contain p-2 group-hover:scale-110 transition-transform duration-500">
                                            <div class="absolute bottom-0 inset-x-0 bg-black/60 text-white text-[10px] py-1 text-center font-bold uppercase tracking-widest backdrop-blur-sm">Pattern: {{ rec.cartoon_name }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div v-if="historySearched && historyResults.length === 0" class="text-center py-20 text-gray-400 italic bg-gray-50 rounded-3xl border-2 border-dashed">
                        <i class="fas fa-box-open text-6xl mb-4 opacity-20"></i>
                        <p class="font-black text-2xl uppercase tracking-widest">No history records found.</p>
                        <p class="text-sm font-bold mt-2">กรุณาตรวจสอบ Item UID อีกครั้ง</p>
                    </div>
                </div>

                <!-- View: Settings -->
                <div v-else-if="currentView === 'settings'" class="bg-white rounded-xl shadow-sm p-6 h-full overflow-y-auto uppercase">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 uppercase">System Settings</h3>
                    <div class="flex border-b mb-6">
                        <button v-for="tab in ['users', 'reasons', 'ink', 'upload']" :key="tab" 
                            @click="settingsTab = tab"
                            :class="['px-6 py-3 font-bold transition-colors border-b-2 uppercase', settingsTab === tab ? 'border-gold-500 text-gold-600' : 'border-transparent text-gray-500 hover:text-gold-700']">
                            {{ tab }}
                        </button>
                    </div>

                    <div v-if="settingsTab === 'users'">
                        <div class="mb-4 flex gap-2">
                            <input v-model="newUser.username" placeholder="Username" class="border rounded px-3 py-2 outline-none focus:ring-1 focus:ring-gold-500 uppercase font-bold">
                            <input v-model="newUser.password" placeholder="Password" class="border rounded px-3 py-2 outline-none focus:ring-1 focus:ring-gold-500">
                            <select v-model="newUser.role" class="border rounded px-3 py-2 outline-none uppercase font-bold"><option value="user">User</option><option value="admin">Admin</option></select>
                            <button @click="addUser" class="bg-green-500 text-white px-4 rounded hover:bg-green-600 font-bold uppercase shadow shadow-green-100">Add</button>
                        </div>
                        <ul class="divide-y border rounded-xl overflow-hidden shadow-sm">
                            <li v-for="u in settingsData.users" :key="u.id" class="py-3 px-4 flex justify-between items-center bg-white hover:bg-gray-50 font-bold">
                                <span class="uppercase tracking-tight">{{u.username}} <span class="bg-gray-100 text-gold-600 text-xs px-2 py-0.5 rounded-full ml-2 uppercase font-bold">{{u.role}}</span></span>
                                <button @click="deleteUser(u.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div v-if="settingsTab === 'reasons'">
                         <div class="mb-4 flex gap-2"><input v-model="newReason" placeholder="New Reason" class="border rounded px-3 py-2 flex-1 outline-none uppercase font-bold"><button @click="addReason" class="bg-green-500 text-white px-4 rounded hover:bg-green-600 font-bold shadow uppercase">ADD</button></div>
                        <ul class="divide-y border rounded-xl shadow-sm font-bold tracking-tight"><li v-for="r in settingsData.reasons" :key="r.id" class="py-3 px-4 flex justify-between items-center bg-white hover:bg-gray-50 uppercase"><span>{{r.reason_text}}</span><button @click="deleteReason(r.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></li></ul>
                    </div>

                    <div v-if="settingsTab === 'ink'">
                        <div class="mb-4 flex gap-2 items-center"><input v-model="newInk.name" placeholder="Ink Name" class="border rounded px-3 py-2 uppercase font-bold"><input v-model="newInk.hex" type="color" class="h-10 w-12 cursor-pointer border rounded bg-white p-1"><button @click="addInk" class="bg-green-500 text-white px-4 py-2 rounded font-bold uppercase shadow">ADD</button></div>
                       <div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div v-for="ink in settingsData.ink" :key="ink.id" class="p-3 border rounded-xl flex justify-between items-center bg-white shadow-sm hover:shadow-md transition"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full border shadow-inner" :style="{backgroundColor: ink.hex_code}"></div><span class="font-bold uppercase tracking-tight">{{ink.ink_name}}</span></div><button @click="deleteInk(ink.id)" class="text-red-400"><i class="fas fa-times"></i></button></div></div>
                    </div>

                    <div v-if="settingsTab === 'upload'">
                        <div class="max-w-lg mx-auto border-2 border-dashed border-gray-300 rounded-3xl p-10 text-center bg-gray-50 uppercase">
                             <div class="mb-4"><label class="block text-sm font-bold mb-2 text-gray-600 uppercase tracking-wide">Target Storage Bucket</label><select v-model="uploadBucket" class="w-full border rounded-xl px-4 py-3 outline-none uppercase font-bold"><option value="Product_Pic">Product Images (Product_Pic)</option><option value="Cartoon_Pic">Patterns (Cartoon_Pic)</option></select></div>
                             <input type="file" ref="imageUploader" accept="image/*" multiple class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-gold-50 file:text-gold-700 hover:file:bg-gold-100 mb-6 font-bold uppercase"/>
                             <button @click="uploadImages" class="w-full bg-gold-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-gold-600 transition uppercase tracking-wide">Start Upload to Bucket</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Report Result Details) -->
    <div v-if="showSessionModal" class="fixed inset-0 z-modal-backdrop flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm p-4 text-left" @click.self="showSessionModal = false">
        <div class="bg-white w-full max-w-7xl h-[90vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden z-modal-content text-left">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 uppercase font-bold">
                <h3 class="text-xl text-gray-700 tracking-tight">เซสชัน: #{{ sessionItems[0]?.session_id || '-' }} | ข้อมูลรายการตรวจสอบอย่างละเอียด</h3>
                <button @click="showSessionModal = false" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-[11px] text-left text-gray-500">
                    <thead class="uppercase bg-gray-100 text-gray-700 sticky top-0 font-bold shadow-sm">
                        <tr>
                            <th class="px-4 py-3 text-center">#</th>
                            <th class="px-4 py-3 text-center">เวลาตรวจ</th>
                            <th class="px-4 py-3 tracking-tighter">Item UID</th>
                            <th class="px-4 py-3 text-center uppercase tracking-tighter">Result</th>
                            <th class="px-4 py-3 text-center">RETRY</th>
                            <th class="px-4 py-3">Product Name / Bill</th>
                            <th class="px-4 py-3">Text Info (Line 1/2/3)</th>
                            <th class="px-4 py-3 text-center tracking-tighter">Ink/Font/Floor</th>
                            <th class="px-4 py-3 uppercase tracking-tighter">Fail Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, idx) in sessionItems" :key="item.id" class="border-b hover:bg-gray-50 font-medium">
                            <td class="px-4 py-3 text-center font-bold text-gray-400">{{ idx + 1 }}</td>
                            <td class="px-4 py-3 text-center font-bold whitespace-nowrap leading-none">{{ formatTime(item.created_at) }}</td>
                            <td class="px-4 py-3 font-mono font-bold text-gold-600 uppercase tracking-tighter">{{ item.item_uid }}</td>
                            <td class="px-4 py-3 text-center uppercase">
                                <span :class="['px-2 py-1 rounded-full font-bold text-[9px]', item.status==='pass'?'bg-green-500 text-white':'bg-red-500 text-white']">{{ item.status }}</span>
                            </td>
                            <td class="px-4 py-3 text-center font-bold">{{ item.retry_count || 1 }}</td>
                            <td class="px-4 py-3 uppercase">
                                <div class="font-bold text-gray-700 leading-tight">{{ item.product_name || '-' }}</div>
                                <div class="text-[9px] text-gold-600 font-black mt-1 leading-none uppercase">Bill: {{ item.bill_no || '-' }}</div>
                            </td>
                            <td class="px-4 py-3 leading-tight uppercase font-medium">
                                <div v-if="item.line1" class="text-gray-800">1: {{ item.line1 }}</div>
                                <div v-if="item.line2" class="text-gray-800">2: {{ item.line2 }}</div>
                                <div v-if="item.line3" class="text-gray-800">3: {{ item.line3 }}</div>
                            </td>
                            <td class="px-4 py-3 text-center uppercase whitespace-nowrap leading-tight text-[10px] font-bold">
                                <div>หมึก: <b class="text-gold-600">{{ item.ink_color || '-' }}</b></div>
                                <div class="mt-0.5 uppercase">ฟอนต์: <b>{{ item.font || '-' }}</b></div>
                                <div class="mt-0.5 text-gray-400 uppercase">ชั้น: <b>{{ item.floor || '-' }}</b></div>
                            </td>
                            <td class="px-4 py-3 italic font-bold text-red-500 uppercase">{{ item.fail_reason || '-' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch, nextTick } = Vue;
        const { createClient } = supabase;

        const SUPABASE_URL = 'https://otswcrrcidtkpjijirax.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90c3djcnJjaWR0a3BqaWppcmF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMDgxODEsImV4cCI6MjA4MTU4NDE4MX0.PGSeQWK7bH5QEyG5do7gnxYhw560QioL1elsf2T0r84';
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const loading = ref(false);
                const user = ref(null);
                const isSidebarOpen = ref(true);
                const currentView = ref('qc');
                const settingsTab = ref('users');
                const barcodeQuery = ref('');
                const barcodeInput = ref(null);
                const loginForm = reactive({ username: '', password: '' });
                const isLoggedIn = computed(() => !!user.value);
                
                const qcState = reactive({ step: 'upload', startTime: null, filename: '' });
                const qcData = reactive({ items: [] });
                const currentItem = ref(null);
                const productExt = ref('.jpg');
                const cartoonExt = ref('.jpg');
                const imgErrors = reactive({ product: false, cartoon: false });

                const hasSavedSession = ref(false);
                const savedSessionInfo = ref(null);

                const menus = [
                    { id: 'qc', label: 'QC Operation', icon: 'fa-qrcode' },
                    { id: 'reject', label: 'Reject', icon: 'fa-ban' },
                    { id: 'report', label: 'Reports & KPI', icon: 'fa-chart-line' },
                    { id: 'history', label: 'History Check', icon: 'fa-history' },
                    { id: 'settings', label: 'Settings', icon: 'fa-cog' }
                ];

                const settingsData = reactive({ users: [], reasons: [], ink: [] });
                const newUser = reactive({ username: '', password: '', role: 'user' });
                const newReason = ref('');
                const newInk = reactive({ name: '', hex: '#000000' });
                const uploadBucket = ref('Product_Pic');
                const imageUploader = ref(null);
                const reports = ref([]);
                const reportFilter = reactive({ 
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date().toISOString().split('T')[0],
                    user: ''
                });
                const historySearch = ref('');
                const historyResults = ref([]);
                const historySearched = ref(false);
                const showSessionModal = ref(false);
                const sessionItems = ref([]);

                const rejectData = reactive({ items: [] });
                const activeRejectTab = ref(1);
                const currentRejectItem = ref(null);
                const rejectSearchQuery = ref('');
                const rejectTotalCount = computed(() => rejectData.items.length);

                const viewTitle = computed(() => menus.find(m => m.id === currentView.value)?.label || 'System');
                const totalItems = computed(() => qcData.items.reduce((a, i) => a + parseInt(i.qty || 1), 0));
                const passedItems = computed(() => qcData.items.filter(i => i.status === 'pass').reduce((a, i) => a + parseInt(i.qty || 1), 0));
                const failedItems = computed(() => qcData.items.filter(i => i.status === 'fail').reduce((a, i) => a + parseInt(i.qty || 1), 0));
                const remainingItems = computed(() => totalItems.value - passedItems.value - failedItems.value);
                const productImageUrl = computed(() => getPublicUrl('Product_Pic', currentItem.value?.product_code, productExt.value));
                const cartoonImageUrl = computed(() => getPublicUrl('Cartoon_Pic', currentItem.value?.cartoon_name, cartoonExt.value));

                onMounted(() => {
                    const savedUser = localStorage.getItem('qc_user');
                    if (savedUser) { user.value = JSON.parse(savedUser); fetchSettings(); fetchRejectItems(); }
                    const backup = localStorage.getItem('qc_temp_session');
                    if (backup) {
                        try {
                            const data = JSON.parse(backup);
                            if (data && data.qcState && data.qcData) {
                                hasSavedSession.value = true;
                                savedSessionInfo.value = data.qcState;
                            }
                        } catch (e) { console.error("Backup data corrupted", e); }
                    }
                    window.addEventListener('keydown', handleKeydown);
                    setInterval(fetchRejectItems, 60000); 
                });

                watch(currentView, (newVal) => { if (newVal === 'reject') fetchRejectItems(); });
                watch([qcState, () => qcData.items], () => {
                    if (qcState.step === 'working' && qcData.items.length > 0) {
                        localStorage.setItem('qc_temp_session', JSON.stringify({ qcState, qcData, lastUpdated: new Date() }));
                    }
                }, { deep: true });

                watch(currentItem, (newVal) => {
                    imgErrors.product = false; imgErrors.cartoon = false;
                    productExt.value = '.jpg'; cartoonExt.value = '.jpg';
                    if (newVal) {
                        nextTick(() => {
                            const el = document.getElementById('item-' + newVal.uid);
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        });
                    }
                });

                const restoreSession = () => {
                    const backup = JSON.parse(localStorage.getItem('qc_temp_session'));
                    if (backup) {
                        Object.assign(qcState, backup.qcState);
                        qcData.items = backup.qcData.items;
                        currentItem.value = qcData.items.find(i => i.status === 'pending') || qcData.items[0];
                        hasSavedSession.value = false;
                        Swal.fire({ title: 'Restored', text: 'กู้คืนข้อมูลสำเร็จ', icon: 'success', timer: 1500 });
                    }
                };

                const clearBackupPrompt = async () => {
                    const { isConfirmed } = await Swal.fire({ title: 'Discard?', text: 'ล้างข้อมูลที่ค้างไว้และเริ่มใหม่ใช่หรือไม่?', icon: 'warning', showCancelButton: true });
                    if (isConfirmed) { localStorage.removeItem('qc_temp_session'); hasSavedSession.value = false; }
                };

                const getPublicUrl = (bucket, filename, ext) => {
                    if (!filename || filename === '0') return '';
                    let name = filename.toString().trim();
                    if (!name.includes('.')) name += ext;
                    return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodeURIComponent(name)}`; 
                };

                const handleImageError = (type) => {
                    if (type === 'product' && productExt.value === '.jpg') productExt.value = '.png';
                    else if (type === 'product') imgErrors.product = true;
                    if (type === 'cartoon' && cartoonExt.value === '.jpg') cartoonExt.value = '.png';
                    else if (type === 'cartoon') imgErrors.cartoon = true;
                };

                const handleLogin = async () => {
                    loading.value = true;
                    try {
                        const { data } = await sb.from('app_users').select('*').eq('username', loginForm.username).eq('password', loginForm.password).single();
                        if (data) { user.value = data; localStorage.setItem('qc_user', JSON.stringify(data)); fetchSettings(); fetchRejectItems(); }
                        else Swal.fire('Error', 'Invalid login', 'error');
                    } catch(e) { console.error(e); }
                    loading.value = false;
                };

                const handleLogout = () => { user.value = null; localStorage.removeItem('qc_user'); qcState.step='upload'; };

                const processCSV = (file) => {
                    loading.value = true;
                    Papa.parse(file, {
                        header: true, skipEmptyLines: true,
                        complete: async (res) => {
                            qcData.items = res.data.map(r => ({
                                uid: r['Item UID'], product_code: r['รหัสสินค้า'], product_name: r['ชื่อสินค้า'], 
                                bill_no: r['เลขบิล'], ink_color: r['สีหมึก'], floor: r['ชั้นที่'], 
                                cartoon_name: r['ลายการ์ตูน'], font: r['ฟอนต์'], 
                                line1: r['บรรทัด 1'], line2: r['บรรทัด 2'], line3: r['บรรทัด 3'],
                                qty: r['จำนวน'], remark: r['หมายเหตุ'], status: 'pending', check_time: null
                            }));
                            qcState.filename = file.name; qcState.startTime = new Date(); qcState.step = 'working';
                            loading.value = false;
                        }
                    });
                };

                const handleFileUpload = (e) => { if(e.target.files[0]) processCSV(e.target.files[0]); };
                const handleDrop = (e) => { if(e.dataTransfer.files[0]) processCSV(e.dataTransfer.files[0]); };
                const handleScan = () => {
                    const query = barcodeQuery.value.trim().toUpperCase();
                    const found = qcData.items.find(i => i.uid === query);
                    if(found) selectItem(found); else Swal.fire({ title: 'Not Found', icon: 'warning', timer: 1000 });
                    barcodeQuery.value = '';
                };

                const selectItem = (item) => currentItem.value = item;
                const navigateItem = (d) => {
                    const idx = qcData.items.indexOf(currentItem.value);
                    if(qcData.items[idx+d]) selectItem(qcData.items[idx+d]);
                };

                const markStatus = async (status) => {
                    if(!currentItem.value) return;
                    let reason = null;
                    if(status === 'fail') {
                        const { value } = await Swal.fire({ 
                            title: 'Select Failure Reason', icon: 'question', input: 'select', 
                            inputOptions: settingsData.reasons.reduce((a,c)=>({...a, [c.reason_text]:c.reason_text}), {'Defect':'Defect General'}),
                            showCancelButton: true 
                        });
                        if(!value) return;
                        reason = value;
                    }
                    currentItem.value.status = status; currentItem.value.fail_reason = reason; currentItem.value.check_time = new Date();
                    navigateItem(1);
                };

                const finishSession = async () => {
                    const { isConfirmed } = await Swal.fire({ title: 'Finish Job?', text:'บันทึกข้อมูลและส่งรายงาน?', icon:'question', showCancelButton: true });
                    if(!isConfirmed) return;
                    loading.value = true;
                    try {
                        const endTime = new Date();
                        const durationSeconds = (endTime - new Date(qcState.startTime)) / 1000;
                        const kpi = durationSeconds / totalItems.value;
                        const { data: session, error: sessErr } = await sb.from('qc_sessions').insert({ 
                            username: user.value.username, filename: qcState.filename, start_time: qcState.startTime, end_time: endTime,
                            total_items: totalItems.value, pass_count: passedItems.value, fail_count: failedItems.value, kpi_score: kpi 
                        }).select().single();
                        if (sessErr) throw sessErr;
                        const records = qcData.items.map(i => ({
                            session_id: session.id, item_uid: i.uid, qc_by: user.value.username, status: i.status, fail_reason: i.fail_reason, 
                            is_rejected: i.status === 'fail', retry_count: 1, product_code: i.product_code, product_name: i.product_name,
                            bill_no: i.bill_no, ink_color: i.ink_color, font: i.font, floor: i.floor, cartoon_name: i.cartoon_name,
                            line1: i.line1, line2: i.line2, line3: i.line3, qty: i.qty, remark: i.remark, created_at: i.check_time || endTime
                        }));
                        await sb.from('qc_records').insert(records);
                        localStorage.removeItem('qc_temp_session');
                        Swal.fire('Success', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                        qcState.step = 'upload'; qcData.items = []; fetchRejectItems();
                    } catch(err) { Swal.fire('Error', err.message, 'error'); } finally { loading.value = false; }
                };

                const fetchRejectItems = async () => {
                    try {
                        const { data } = await sb.from('qc_records').select('*').eq('is_rejected', true);
                        if (data) rejectData.items = data;
                    } catch (e) { console.error(e); }
                };

                const filteredRejectItems = computed(() => {
                    let items = rejectData.items.filter(i => i.retry_count === activeRejectTab.value);
                    if (rejectSearchQuery.value) {
                        const q = rejectSearchQuery.value.trim().toUpperCase();
                        items = items.filter(i => i.item_uid.includes(q));
                    }
                    return items;
                });

                const getRejectCountByTab = (tab) => rejectData.items.filter(i => i.retry_count === tab).length;
                const handleRejectScan = () => {
                    const found = filteredRejectItems.value.find(i => i.item_uid === rejectSearchQuery.value.trim().toUpperCase());
                    if (found) currentRejectItem.value = found;
                    else Swal.fire({ title: 'Not Found in Tab', icon: 'warning', timer: 1000 });
                    rejectSearchQuery.value = '';
                };

                const navigateRejectItem = (d) => {
                    const list = filteredRejectItems.value;
                    if (list.length === 0) return;
                    const idx = list.indexOf(currentRejectItem.value);
                    const newIdx = idx + d;
                    if (newIdx >= 0 && newIdx < list.length) {
                        currentRejectItem.value = list[newIdx];
                    }
                };

                const markRejectStatus = async (status) => {
                    if (!currentRejectItem.value) return;
                    const item = currentRejectItem.value;
                    let updates = { status: status, qc_by: user.value.username, created_at: new Date() };

                    if (status === 'pass') {
                        updates.is_rejected = false;
                    } else {
                        const { value } = await Swal.fire({ 
                            title: 'New Failure Reason', icon: 'question', input: 'select', 
                            inputOptions: settingsData.reasons.reduce((a,c)=>({...a, [c.reason_text]:c.reason_text}), {'Defect':'Defect General'}),
                            showCancelButton: true 
                        });
                        if (!value) return; 
                        updates.fail_reason = value;
                        updates.retry_count = Math.min((item.retry_count || 1) + 1, 6);
                    }

                    loading.value = true;
                    try {
                        const { error } = await sb.from('qc_records').update(updates).eq('id', item.id);
                        if (error) throw error;
                        await fetchRejectItems();
                        currentRejectItem.value = null;
                        Swal.fire({ title: 'Updated', icon: 'success', timer: 1000 });
                    } catch (err) {
                        Swal.fire('Error', err.message, 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchSettings = async () => {
                    const [u, r, i] = await Promise.all([
                        sb.from('app_users').select('*'), sb.from('settings_reasons').select('*'), sb.from('settings_ink').select('*')
                    ]);
                    if(u.data) settingsData.users = u.data;
                    if(r.data) settingsData.reasons = r.data;
                    if(i.data) settingsData.ink = i.data;
                };

                const fetchReports = async () => {
                    loading.value = true;
                    try {
                        let query = sb.from('qc_sessions')
                            .select('*')
                            .gte('created_at', reportFilter.startDate + 'T00:00:00')
                            .lte('created_at', reportFilter.endDate + 'T23:59:59')
                            .not('end_time', 'is', null);
                        
                        if (reportFilter.user) {
                            query = query.eq('username', reportFilter.user);
                        }

                        const { data } = await query.order('created_at', { ascending: false });
                        reports.value = data || [];
                    } finally { loading.value = false; }
                };

                const searchHistory = async () => {
                    if(!historySearch.value) return;
                    loading.value = true; historySearched.value = true; historyResults.value = []; 
                    try {
                        const searchStr = historySearch.value.trim();
                        const { data, error } = await sb.from('qc_records').select('*').ilike('item_uid', searchStr).order('created_at', {ascending:false});
                        if(error) throw error;
                        historyResults.value = data || [];
                        if(historyResults.value.length === 0) Swal.fire({ title: 'Not Found', text: 'ไม่พบประวัติการตรวจสำหรับ UID นี้', icon: 'info', timer: 2000 });
                    } catch (err) { Swal.fire('Error', 'ไม่สามารถค้นหาข้อมูลได้: ' + err.message, 'error'); } finally { loading.value = false; }
                };

                const clearHistorySearch = () => {
                    historySearch.value = '';
                    historyResults.value = [];
                    historySearched.value = false;
                };

                const showSessionDetails = async (session) => {
                    loading.value = true;
                    try {
                        const { data } = await sb.from('qc_records').select('*').eq('session_id', session.id).order('created_at', {ascending:true});
                        sessionItems.value = data || []; showSessionModal.value = true;
                    } finally { loading.value = false; }
                };

                const downloadReport = async (s) => {
                    loading.value = true;
                    try {
                        const { data } = await sb.from('qc_records').select('*').eq('session_id', s.id).order('created_at', {ascending: true});
                        if(!data || data.length === 0) return;
                        let prevTime = new Date(s.start_time).getTime();
                        const csvData = data.map(r => {
                            const currTime = new Date(r.created_at).getTime();
                            const durationDiff = (currTime - prevTime) / 1000; prevTime = currTime; const dateObj = new Date(r.created_at);
                            return { 
                                'Date': dateObj.toLocaleDateString('th-TH'), 
                                'Time': dateObj.toLocaleTimeString('th-TH'), 
                                'KPI (Duration)': formatDuration(durationDiff), 
                                'Item_UID': r.item_uid, 
                                'Status': r.status, 
                                'Retry': r.retry_count || 1,
                                'Fail_Reason': r.fail_reason || '-', 
                                'QC_By': r.qc_by, 
                                'product_name': r.product_name || '-', 
                                'product_code': r.product_code || '-', 
                                'Bill_No': r.bill_no || '-',
                                'cartoon_name': r.cartoon_name || '-', 
                                'ink_color': r.ink_color || '-', 
                                'font': r.font || '-', 
                                'floor': r.floor || '-', 
                                'line1': r.line1 || '-', 
                                'line2': r.line2 || '-', 
                                'line3': r.line3 || '-', 
                                'remark': r.remark || '-' 
                            };
                        });
                        const csv = '\uFEFF' + Papa.unparse(csvData);
                        const link = document.createElement('a'); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `Report_${s.filename}.csv`; link.click();
                    } finally { loading.value = false; }
                };

                const uploadImages = async () => {
                    if(!imageUploader.value.files.length) return;
                    loading.value = true; let count = 0, fail = 0;
                    for (let file of imageUploader.value.files) {
                        const { error } = await sb.storage.from(uploadBucket.value).upload(file.name, file, { upsert: true });
                        if(error) fail++; else count++;
                    }
                    loading.value = false; Swal.fire('Completed', `Uploaded: ${count}, Failed: ${fail}`, 'success');
                };

                const addUser = async () => { if(newUser.username){ await sb.from('app_users').insert({...newUser}); newUser.username=''; fetchSettings(); }};
                const deleteUser = async (id) => { await sb.from('app_users').delete().eq('id',id); fetchSettings(); };
                const addReason = async () => { if(newReason.value){ await sb.from('settings_reasons').insert({reason_text:newReason.value}); newReason.value=''; fetchSettings(); }};
                const deleteReason = async (id) => { await sb.from('settings_reasons').delete().eq('id',id); fetchSettings(); };
                const addInk = async () => { if(newInk.name){ await sb.from('settings_ink').insert({ink_name:newInk.name, hex_code:newInk.hex}); newInk.name=''; fetchSettings(); }};
                const deleteInk = async (id) => { await sb.from('settings_ink').delete().eq('id',id); fetchSettings(); };

                const handleKeydown = (e) => {
                    if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
                    
                    // QC Operation Keyboard Nav
                    if (currentView.value === 'qc' && qcState.step === 'working') {
                        if (e.key === 'ArrowLeft') navigateItem(-1);
                        if (e.key === 'ArrowRight') navigateItem(1);
                    }
                    
                    // Reject Keyboard Nav
                    if (currentView.value === 'reject' && currentRejectItem.value) {
                        if (e.key === 'ArrowLeft') navigateRejectItem(-1);
                        if (e.key === 'ArrowRight') navigateRejectItem(1);
                    }
                };

                const openInNewTab = (url) => {
                    if(url) window.open(url, '_blank');
                };

                const formatDate = (d) => {
                    if(!d) return '-'; const date = new Date(d); if (isNaN(date.getTime())) return '-';
                    return date.toLocaleDateString('th-TH', {year:'2-digit', month:'2-digit', day:'2-digit'}) + ' ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                };
                const formatTime = (d) => { if(!d) return '-'; const date = new Date(d); if (isNaN(date.getTime())) return '-'; return date.toLocaleTimeString('th-TH'); };
                const formatDuration = (s) => { const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; };
                const getInkColor = (name) => settingsData.ink.find(i=>i.ink_name===name)?.hex_code || '#ddd';

                return {
                    loading, user, isLoggedIn, currentView, viewTitle, isSidebarOpen, loginForm, qcState, qcData, currentItem, totalItems, passedItems, failedItems, remainingItems, barcodeQuery, barcodeInput, productImageUrl, cartoonImageUrl, imgErrors, handleLogin, handleLogout, handleFileUpload, handleDrop, handleScan, selectItem, navigateItem, markStatus, finishSession, handleImageError, settingsTab, settingsData, newUser, newReason, newInk, uploadBucket, imageUploader, uploadImages, reports, reportFilter, fetchReports, searchHistory, historySearch, historyResults, historySearched, clearHistorySearch, showSessionModal, sessionItems, showSessionDetails, downloadReport, menus, formatDate, formatTime, formatDuration, getInkColor, addUser, deleteUser, addReason, deleteReason, addInk, deleteInk,
                    hasSavedSession, savedSessionInfo, restoreSession, clearBackupPrompt, getPublicUrl,
                    rejectData, activeRejectTab, currentRejectItem, rejectSearchQuery, rejectTotalCount, fetchRejectItems, filteredRejectItems, getRejectCountByTab, handleRejectScan, markRejectStatus, navigateRejectItem, openInNewTab
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
